<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart TBM : Enterprise Safety Management</title>
    
    <!-- React & ReactDOM (Core) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (Transpiler) -->
    <script src="https://unpkg.com/@babel/standalone@7.23.5/babel.min.js"></script>
    
    <!-- Tailwind CSS (Styling) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- PDF Generation Libs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- FontAwesome & Google Fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Pen+Script&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, where, updateDoc, setDoc, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        
        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyBYC9PUBg62xJi7L_C692VX6RwziN8B-GU",
            authDomain: "dol-party.firebaseapp.com",
            projectId: "dol-party",
            storageBucket: "dol-party.firebasestorage.app",
            messagingSenderId: "489405410374",
            appId: "1:489405410374:web:9985f13204301ad3fcee47",
            measurementId: "G-YKZ3LC9YL8"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Expose to window for React to use
        window.db = db;
        window.auth = auth;
        window.firebaseModules = { collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, where, updateDoc, setDoc, getDocs, getDoc, signInAnonymously };
    </script>

    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f3f4f6; }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .signature-font { font-family: 'Nanum Pen Script', cursive; font-size: 1.5rem; color: #1e40af; }
        
        /* Print/PDF specific styles */
        .print-only { display: none; }
        
        /* Canvas specific */
        canvas { touch-action: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        const { collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, where, updateDoc, setDoc, getDocs, getDoc, signInAnonymously } = window.firebaseModules;
        const db = window.db;
        const auth = window.auth;
        const { jsPDF } = window.jspdf;

        // --- Utils (ISO 8601 Standard) ---
        const getWeekNumber = (d) => {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            const weekNo = Math.ceil(( ( (d - yearStart) / 86400000) + 1)/7);
            return weekNo;
        };

        const getFormattedWeek = (dateStr) => {
            const d = new Date(dateStr);
            const year = d.getFullYear();
            const month = d.getMonth() + 1;
            const firstDayOfMonth = new Date(year, month - 1, 1);
            const firstDayOfWeek = firstDayOfMonth.getDay();
            const offsetDate = d.getDate() + firstDayOfWeek - 1;
            const weekOfMonth = Math.floor(offsetDate / 7) + 1;
            return `${year}ë…„ ${month}ì›” ${weekOfMonth}ì£¼ì°¨`;
        };

        // FIXED: ISO 8601 compliant week date range calculator
        const getWeekDetails = (year, weekNo) => {
            const jan4 = new Date(year, 0, 4);
            const day = jan4.getDay() || 7; // Mon=1, Sun=7
            const week1Start = new Date(jan4);
            week1Start.setDate(jan4.getDate() - day + 1); // Start of ISO Week 1 (Monday)

            const start = new Date(week1Start);
            start.setDate(week1Start.getDate() + (weekNo - 1) * 7);
            
            const end = new Date(start);
            end.setDate(start.getDate() + 6);
            
            const fmt = (date) => `${String(date.getMonth() + 1).padStart(2, '0')}.${String(date.getDate()).padStart(2, '0')}`;
            
            const thursday = new Date(start);
            thursday.setDate(start.getDate() + 3);
            const month = thursday.getMonth() + 1;
            
            const weekOfMonth = Math.ceil(start.getDate() / 7);

            return {
                startYear: start.getFullYear(),
                label: `${year}ë…„ ${month}ì›” ${weekOfMonth}ì£¼ì°¨ (${fmt(start)}~${fmt(end)})`,
                value: `${year}-W${weekNo}`
            };
        };

        // --- Error Boundary ---
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="flex flex-col items-center justify-center h-screen bg-red-50 text-red-800 p-8">
                            <i className="fas fa-exclamation-triangle text-6xl mb-4"></i>
                            <h1 className="text-3xl font-bold mb-2">ì‹œìŠ¤í…œ ì˜¤ë¥˜ ë°œìƒ</h1>
                            <p className="mb-6 text-center max-w-md">ì¼ì‹œì ì¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.<br/>(Error: {this.state.error.message})</p>
                            <button onClick={() => window.location.reload()} className="px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition shadow-lg">ì¬ì‹œì‘</button>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // --- Helper Components ---
        const Toast = ({ message, type, onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 3000);
                return () => clearTimeout(timer);
            }, []);
            const bgClass = type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-blue-600';
            return (
                <div className={`fixed top-5 right-5 ${bgClass} text-white px-6 py-3 rounded-lg shadow-xl z-50 flex items-center animate-bounce-in z-50`}>
                    <i className={`fas ${type === 'success' ? 'fa-check-circle' : 'fa-info-circle'} mr-3`}></i>
                    {message}
                </div>
            );
        };

        // --- Chart Components ---
        const KPICard = ({ title, value, icon, color, subtext }) => (
            <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
                <div className="flex justify-between items-start">
                    <div>
                        <p className="text-sm text-gray-500 mb-1 font-medium">{title}</p>
                        <h3 className="text-3xl font-bold text-gray-800">{value}</h3>
                    </div>
                    <div className={`p-3 rounded-lg ${color} bg-opacity-10 text-${color.split('-')[1]}-600`}>
                        <i className={`fas ${icon} text-xl`}></i>
                    </div>
                </div>
                <p className="text-xs text-gray-400 mt-4">{subtext}</p>
            </div>
        );

        const SimpleBarChart = ({ data }) => {
            const values = data.map(d => d.value);
            const maxVal = Math.max(...values);
            const scaleMax = maxVal === 0 ? 5 : maxVal <= 5 ? maxVal + 2 : maxVal * 1.2;
            
            return (
                <div className="h-64 flex items-end justify-around space-x-2 pt-10 border-b border-gray-200">
                    {data.map((d, i) => (
                        <div key={i} className="flex flex-col items-center w-full group">
                            <div className="relative w-full flex justify-center h-full items-end">
                                <div className="absolute -top-8 bg-gray-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity z-10">
                                    {d.value}ê±´
                                </div>
                                <div 
                                    className="w-3/5 bg-indigo-500 rounded-t-md hover:bg-indigo-600 transition-all duration-500 relative"
                                    style={{ height: `${(d.value / scaleMax) * 100}%`, minHeight: d.value > 0 ? '4px' : '0' }}
                                >
                                </div>
                            </div>
                            <span className="text-xs text-gray-500 mt-2 font-medium">{d.label}</span>
                        </div>
                    ))}
                </div>
            );
        };

        const DonutChart = ({ data }) => {
            const total = data.reduce((acc,cur) => acc + cur.value, 0); 
            const renderTotal = total || 1; 
            const colors = ['#6366f1', '#ec4899', '#10b981', '#f59e0b'];
            
            return (
                <div className="flex flex-col items-center justify-center pt-2">
                    <div className="relative w-40 h-40 rounded-full border-8 border-gray-100 flex items-center justify-center">
                        {total > 0 && (
                            <div className="absolute inset-0 rounded-full opacity-20 bg-[conic-gradient(at_center,_var(--tw-gradient-stops))] from-indigo-500 via-purple-500 to-pink-500"></div>
                        )}
                        <div className="text-center">
                            <div className="text-2xl font-bold text-gray-800">{total}</div>
                            <div className="text-xs text-gray-500">Total</div>
                        </div>
                    </div>
                    <div className="mt-6 w-full space-y-2">
                        {total === 0 ? (
                            <div className="text-center text-sm text-gray-400 py-4">ë“±ë¡ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
                        ) : (
                            data.slice(0,4).map((d, i) => (
                                <div key={i} className="flex justify-between text-sm px-4">
                                    <span className="flex items-center"><span className="w-3 h-3 rounded-full mr-2" style={{backgroundColor: colors[i%4]}}></span>{d.label}</span>
                                    <span className="font-bold">{Math.round((d.value/renderTotal)*100)}%</span>
                                </div>
                            ))
                        )}
                    </div>
                </div>
            );
        };

        const RiskGauge = ({ score }) => {
            const rotation = (score / 100) * 180;
            const color = score > 80 ? '#22c55e' : score > 50 ? '#eab308' : '#ef4444';
            return (
                <div className="relative w-48 h-24 overflow-hidden mx-auto mt-4">
                    <div className="absolute top-0 left-0 w-full h-full bg-gray-200 rounded-t-full"></div>
                    <div className="absolute top-0 left-0 w-full h-full rounded-t-full origin-bottom transform transition-transform duration-1000 ease-out" style={{ background: color, transform: `rotate(${rotation - 180}deg)` }}></div>
                    <div className="absolute bottom-0 left-1/2 transform -translate-x-1/2 translate-y-1/2 w-32 h-32 bg-white rounded-full flex items-center justify-center border-4 border-gray-100">
                        <span className="text-2xl font-bold -mt-8 text-gray-700">{score}ì </span>
                    </div>
                </div>
            );
        };

        // --- Signature Pad Component ---
        const SignatureModal = ({ isOpen, onClose, onSave, signerName }) => {
            const canvasRef = useRef(null);
            const isDrawing = useRef(false);
            const [hasSigned, setHasSigned] = useState(false);

            useEffect(() => {
                if (isOpen && canvasRef.current) {
                    const canvas = canvasRef.current;
                    const ctx = canvas.getContext('2d');
                    ctx.lineWidth = 3;
                    ctx.lineCap = 'round';
                    ctx.strokeStyle = 'black';
                    
                    setTimeout(() => {
                        const rect = canvas.getBoundingClientRect();
                        canvas.width = rect.width;
                        canvas.height = rect.height;
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                    }, 50);
                    
                    setHasSigned(false);
                }
            }, [isOpen]);

            const getPos = (e) => {
                const canvas = canvasRef.current;
                const rect = canvas.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;

                return {
                    x: (clientX - rect.left) * scaleX,
                    y: (clientY - rect.top) * scaleY
                };
            };

            const startDrawing = (e) => {
                isDrawing.current = true;
                const { x, y } = getPos(e);
                const ctx = canvasRef.current.getContext('2d');
                ctx.beginPath();
                ctx.moveTo(x, y);
            };

            const draw = (e) => {
                if (!isDrawing.current) return;
                e.preventDefault();
                const { x, y } = getPos(e);
                const ctx = canvasRef.current.getContext('2d');
                ctx.lineTo(x, y);
                ctx.stroke();
                setHasSigned(true);
            };

            const stopDrawing = () => {
                isDrawing.current = false;
            };

            const handleSave = () => {
                if (!hasSigned) return;
                const dataUrl = canvasRef.current.toDataURL();
                onSave(dataUrl);
                onClose();
            };

            const handleClear = () => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                setHasSigned(false);
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg flex flex-col">
                        <div className="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-xl">
                            <h3 className="font-bold text-lg text-gray-800"><i className="fas fa-pen-nib mr-2 text-indigo-600"></i>ì „ì ì„œëª… ({signerName})</h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600"><i className="fas fa-times text-xl"></i></button>
                        </div>
                        <div className="p-4 bg-gray-100 flex-1 relative h-64">
                            <canvas
                                ref={canvasRef}
                                style={{width: '100%', height: '100%'}}
                                className="bg-white rounded border border-gray-300 shadow-inner block cursor-crosshair"
                                onMouseDown={startDrawing}
                                onMouseMove={draw}
                                onMouseUp={stopDrawing}
                                onMouseLeave={stopDrawing}
                                onTouchStart={startDrawing}
                                onTouchMove={draw}
                                onTouchEnd={stopDrawing}
                            />
                            {!hasSigned && <div className="absolute inset-0 flex items-center justify-center pointer-events-none opacity-30 text-2xl font-bold text-gray-400">ì„œëª…í•´ ì£¼ì„¸ìš”</div>}
                        </div>
                        <div className="p-4 border-t flex justify-between gap-3">
                            <button onClick={handleClear} className="px-4 py-2 border border-gray-300 text-gray-600 rounded hover:bg-gray-50"><i className="fas fa-eraser mr-1"></i> ì§€ìš°ê¸°</button>
                            <div className="flex gap-2">
                                <button onClick={onClose} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">ì·¨ì†Œ</button>
                                <button onClick={handleSave} disabled={!hasSigned} className={`px-6 py-2 text-white rounded font-bold shadow ${!hasSigned ? 'bg-gray-400 cursor-not-allowed' : 'bg-indigo-600 hover:bg-indigo-700'}`}>ì„œëª… ì™„ë£Œ</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Hidden PDF Generator (Auto Download - Fixed Layout) ---
        const PdfHiddenGenerator = ({ tbm, onComplete }) => {
            const printRef = useRef(null);
            
            useEffect(() => {
                const generate = async () => {
                    if(!printRef.current) return;
                    try {
                        await new Promise(resolve => setTimeout(resolve, 500));
                        const canvas = await html2canvas(printRef.current, { scale: 2 });
                        const imgData = canvas.toDataURL('image/png');
                        const pdf = new jsPDF('p', 'mm', 'a4');
                        const pdfWidth = pdf.internal.pageSize.getWidth();
                        const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                        pdf.save(`TBM_${tbm.date}_${tbm.department}.pdf`);
                    } catch (e) {
                        console.error("PDF Gen Error", e);
                    } finally {
                        onComplete();
                    }
                };
                generate();
            }, []);

            return (
                <div style={{ position: 'fixed', left: '-10000px', top: 0 }}>
                    <div ref={printRef} className="bg-white p-8 text-black w-[210mm] min-h-[297mm] text-sm leading-relaxed border border-gray-300 font-sans">
                        <h1 className="text-3xl font-bold text-center mb-8 pb-4 border-b-2 border-black">Tool Box Meeting íšŒì˜ë¡</h1>
                        
                        <table className="w-full border-collapse border-2 border-black mb-6 table-fixed">
                            <tbody>
                                <tr className="h-10">
                                    <th className="border border-black bg-gray-100 w-[15%] text-center align-middle font-bold" style={{verticalAlign: 'middle'}}>TBM ì¼ì‹œ</th>
                                    <td className="border border-black pl-2 align-middle" style={{verticalAlign: 'middle'}}>{tbm.date} {tbm.startTime} ~ {tbm.endTime}</td>
                                    <th className="border border-black bg-gray-100 w-[15%] text-center align-middle font-bold" style={{verticalAlign: 'middle'}}>ì‘ì„±ì</th>
                                    <td className="border border-black pl-2 align-middle" style={{verticalAlign: 'middle'}}>{tbm.leader} ({tbm.department})</td>
                                </tr>
                                <tr className="h-10">
                                    <th className="border border-black bg-gray-100 text-center align-middle font-bold" style={{verticalAlign: 'middle'}}>ì‘ì—…ëª…</th>
                                    <td colSpan="3" className="border border-black pl-2 align-middle font-bold" style={{verticalAlign: 'middle'}}>{tbm.workName}</td>
                                </tr>
                                <tr className="h-10">
                                    <th className="border border-black bg-gray-100 text-center align-middle font-bold" style={{verticalAlign: 'middle'}}>ì‘ì—…ì¥ì†Œ</th>
                                    <td className="border border-black pl-2 align-middle" style={{verticalAlign: 'middle'}}>{tbm.location}</td>
                                    <th className="border border-black bg-gray-100 text-center align-middle font-bold text-xs" style={{verticalAlign: 'middle'}}>ìœ„í—˜ì„±í‰ê°€<br/>ì‹¤ì‹œì—¬ë¶€</th>
                                    <td className="border border-black pl-2 align-middle text-center" style={{verticalAlign: 'middle'}}>{tbm.riskAssessmentDone ? 'â˜‘ ì˜ˆ' : 'â˜ ì•„ë‹ˆì˜¤'}</td>
                                </tr>
                                <tr className="h-10">
                                    <th className="border border-black bg-gray-100 text-center align-middle font-bold" style={{verticalAlign: 'middle'}}>í˜„ì¥ í™˜ê²½</th>
                                    <td colSpan="3" className="border border-black pl-2 align-middle" style={{verticalAlign: 'middle'}}>
                                        <span className="mr-6"><strong>ì˜¨ë„:</strong> {tbm.temperature || '-'}â„ƒ</span>
                                        <span><strong>ìŠµë„:</strong> {tbm.humidity || '-'}%</span>
                                    </td>
                                </tr>
                                <tr>
                                    <th className="border border-black bg-gray-100 text-center align-middle font-bold" style={{verticalAlign: 'middle'}}>ì‘ì—…ë‚´ìš©</th>
                                    <td colSpan="3" className="border border-black p-2 h-24 align-top whitespace-pre-wrap leading-normal" style={{verticalAlign: 'top'}}>{tbm.workDesc}</td>
                                </tr>
                            </tbody>
                        </table>

                        <div className="mb-6">
                            <h4 className="font-bold mb-2 border-l-4 border-black pl-2">1. ìœ„í—˜ìš”ì¸ ë° ëŒ€ì±…</h4>
                            <table className="w-full border-collapse border border-black text-sm table-fixed">
                                <thead>
                                    <tr className="bg-gray-100 h-8">
                                        <th className="border border-black w-[10%] text-center align-middle" style={{verticalAlign: 'middle'}}>No</th>
                                        <th className="border border-black w-[45%] text-center align-middle" style={{verticalAlign: 'middle'}}>ì ì¬ìœ„í—˜ìš”ì¸</th>
                                        <th className="border border-black w-[45%] text-center align-middle" style={{verticalAlign: 'middle'}}>ì•ˆì „ëŒ€ì±…</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {tbm.risks && tbm.risks.map((r, i) => (
                                        <tr key={i} className="h-auto">
                                            <td className="border border-black text-center align-middle p-1" style={{verticalAlign: 'middle'}}>{i+1}</td>
                                            <td className="border border-black pl-2 align-middle p-1 whitespace-pre-wrap" style={{verticalAlign: 'middle'}}>{r.factor}</td>
                                            <td className="border border-black pl-2 align-middle p-1 whitespace-pre-wrap" style={{verticalAlign: 'middle'}}>{r.measure}</td>
                                        </tr>
                                    ))}
                                    {(!tbm.risks || tbm.risks.length === 0) && <tr><td colSpan="3" className="border border-black p-4 text-center">ê¸°ë¡ ì—†ìŒ</td></tr>}
                                </tbody>
                            </table>
                        </div>

                        <div className="mb-6">
                            <table className="w-full border-collapse border-2 border-black table-fixed">
                                <tbody>
                                    <tr>
                                        <th className="border border-black bg-gray-100 w-[15%] text-center align-middle font-bold" rowSpan="2" style={{verticalAlign: 'middle'}}>ì¤‘ì ìœ„í—˜<br/>ìš”ì¸</th>
                                        <th className="border border-black w-[15%] text-center align-middle bg-gray-50" style={{verticalAlign: 'middle'}}>ì„ ì •</th>
                                        <td className="border border-black p-2 align-middle font-bold whitespace-pre-wrap" style={{verticalAlign: 'middle'}}>{tbm.keyRiskFactor || '-'}</td>
                                    </tr>
                                    <tr>
                                        <th className="border border-black w-[15%] text-center align-middle bg-gray-50" style={{verticalAlign: 'middle'}}>ëŒ€ì±…</th>
                                        <td className="border border-black p-2 align-middle text-blue-700 whitespace-pre-wrap" style={{verticalAlign: 'middle'}}>{tbm.keyRiskMeasure || '-'}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div className="mb-6">
                            <h4 className="font-bold mb-2 border-l-4 border-black pl-2">2. ì‘ì—… ì „ ì•ˆì „ì¡°ì¹˜ í™•ì¸</h4>
                            <table className="w-full border-collapse border border-black text-sm table-fixed">
                                <thead>
                                    <tr className="bg-gray-100 h-8">
                                        <th className="border border-black w-[50%] text-center align-middle" style={{verticalAlign: 'middle'}}>ì ì¬ìœ„í—˜ìš”ì†Œ(ì¤‘ì ìœ„í—˜ í¬í•¨)</th>
                                        <th className="border border-black w-[20%] text-center align-middle" style={{verticalAlign: 'middle'}}>ì¡°ì¹˜ ì—¬ë¶€</th>
                                        <th className="border border-black w-[30%] text-center align-middle" style={{verticalAlign: 'middle'}}>'ì•„ë‹ˆì˜¤'ì¸ ê²½ìš° ì¡°ì¹˜ ë‚´ìš©</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {tbm.safetyActionChecks && tbm.safetyActionChecks.length > 0 ? (
                                        tbm.safetyActionChecks.map((check, i) => (
                                            <tr key={i} className="h-auto">
                                                <td className="border border-black pl-2 align-middle p-1 whitespace-pre-wrap" style={{verticalAlign: 'middle'}}>{check.risk}</td>
                                                <td className="border border-black text-center align-middle p-1" style={{verticalAlign: 'middle'}}>
                                                    {check.result === 'yes' ? 'â˜‘ ì˜ˆ' : 'â˜ ì•„ë‹ˆì˜¤'}
                                                </td>
                                                <td className="border border-black pl-2 align-middle p-1 whitespace-pre-wrap" style={{verticalAlign: 'middle'}}>{check.action || '-'}</td>
                                            </tr>
                                        ))
                                    ) : (
                                        <tr><td colSpan="3" className="border border-black p-2 text-center text-gray-400">- ë³„ë„ ê¸°ë¡ ì—†ìŒ -</td></tr>
                                    )}
                                </tbody>
                            </table>
                        </div>

                        <div className="mb-6">
                            <h4 className="font-bold mb-2 border-l-4 border-black pl-2">3. ì‘ì—… ì „ ì¼ì¼ ì•ˆì „ì ê²€ ì‹œí–‰ ê²°ê³¼</h4>
                            <div className="border border-black p-2 min-h-[50px] whitespace-pre-wrap">
                                {tbm.dailyCheckResult || 'íŠ¹ì´ì‚¬í•­ ì—†ìŒ'}
                            </div>
                        </div>

                        {tbm.photoUrl && (
                            <div className="mb-6">
                                <h4 className="font-bold mb-2 border-l-4 border-black pl-2">4. TBM í™œë™ ì‚¬ì§„</h4>
                                <div className="border border-black p-2 flex justify-center">
                                    <img src={tbm.photoUrl} alt="í™œë™ì‚¬ì§„" className="max-h-60 object-contain" />
                                </div>
                            </div>
                        )}

                        <div className="break-inside-avoid">
                            <h4 className="font-bold mb-2 border-l-4 border-black pl-2">5. ì°¸ì„ì ëª…ë‹¨ (ì´ {tbm.attendees?.length || 0}ëª…)</h4>
                            <div className="grid grid-cols-4 gap-0 border-2 border-black">
                                <div className="bg-gray-100 border-r border-b border-black text-center p-1 font-bold" style={{verticalAlign: 'middle'}}>ì´ë¦„</div>
                                <div className="bg-gray-100 border-r border-b border-black text-center p-1 font-bold" style={{verticalAlign: 'middle'}}>ì„œëª…</div>
                                <div className="bg-gray-100 border-r border-b border-black text-center p-1 font-bold" style={{verticalAlign: 'middle'}}>ì´ë¦„</div>
                                <div className="bg-gray-100 border-b border-black text-center p-1 font-bold" style={{verticalAlign: 'middle'}}>ì„œëª…</div>
                                
                                {tbm.attendees && tbm.attendees.map((att, i) => (
                                    <React.Fragment key={i}>
                                        <div className="border-r border-b border-black p-2 flex items-center justify-center h-16 font-bold">{att.name}</div>
                                        <div className={`border-b border-black p-1 flex items-center justify-center h-16 ${i % 2 === 0 ? 'border-r' : ''}`}>
                                            {att.signatureUrl ? (
                                                <img src={att.signatureUrl} alt="ì„œëª…" className="max-h-12 max-w-full object-contain" />
                                            ) : <span className="text-gray-300 text-xs">(ë¯¸ì„œëª…)</span>}
                                        </div>
                                    </React.Fragment>
                                ))}
                                {tbm.attendees && tbm.attendees.length % 2 !== 0 && (
                                    <>
                                        <div className="border-r border-b border-black p-2 h-16"></div>
                                        <div className="border-b border-black p-1 h-16"></div>
                                    </>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Weekly Status Panel ---
        const WeeklyStatusPanel = ({ accounts, tbms, currentYear }) => {
            const [selectedWeek, setSelectedWeek] = useState(`${currentYear}-W${getWeekNumber(new Date())}`);
            
            useEffect(() => {
                setSelectedWeek(`${currentYear}-W${getWeekNumber(new Date())}`);
            }, [currentYear]);

            const weekOptions = useMemo(() => {
                const weeks = [];
                for(let i=1; i<=53; i++) {
                    const details = getWeekDetails(parseInt(currentYear), i);
                    if (details.startYear > parseInt(currentYear)) continue;
                    weeks.push(details);
                }
                return weeks;
            }, [currentYear]);

            const handleSendEmail = (deptName) => {
                const subject = `[TBM ë¯¸ì œì¶œ ì•Œë¦¼] ${selectedWeek} ${deptName}`;
                const body = `${deptName} ë‹´ë‹¹ìë‹˜,\n\n${selectedWeek} TBM í™œë™ ë‚´ì—­ì´ ì•„ì§ ì œì¶œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\ní™•ì¸ í›„ ì œì¶œ ë¶€íƒë“œë¦½ë‹ˆë‹¤.\n\nê°ì‚¬í•©ë‹ˆë‹¤.`;
                const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                window.location.href = mailtoLink;
            };

            const statusData = useMemo(() => {
                const deptList = accounts
                    .filter(a => a.role !== 'master')
                    .map(a => a.department)
                    .sort((a, b) => a.localeCompare(b, 'ko'));
                
                const selectedWeekNum = parseInt(selectedWeek.split('-W')[1]);
                
                const result = deptList.map(dept => {
                    const submitted = tbms.find(t => {
                        if (t.department !== dept) return false;
                        if (!t.date.startsWith(currentYear)) return false;
                        return getWeekNumber(new Date(t.date)) === selectedWeekNum;
                    });
                    return { department: dept, submitted: !!submitted, data: submitted };
                });
                return result;
            }, [accounts, tbms, selectedWeek, currentYear]);

            return (
                <div className="bg-indigo-50 border border-indigo-100 rounded-lg p-4 mb-6">
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-2">
                        <h3 className="font-bold text-indigo-800"><i className="fas fa-calendar-check mr-2"></i>ì£¼ê°„ ë¶€ì„œë³„ ì œì¶œ í˜„í™©</h3>
                        <select className="border border-indigo-200 rounded px-3 py-1 text-sm bg-white w-full sm:w-auto font-bold text-gray-700" value={selectedWeek} onChange={e=>setSelectedWeek(e.target.value)}>
                            {weekOptions.map(w => <option key={w.value} value={w.value}>{w.label}</option>)}
                        </select>
                    </div>
                    <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3">
                        {statusData.map(s => (
                            <div key={s.department} className={`p-3 rounded border text-center transition flex flex-col items-center justify-center ${s.submitted ? 'bg-white border-green-200 shadow-sm' : 'bg-gray-50 border-red-200 opacity-80'}`}>
                                <div className="text-xs text-gray-500 mb-1">{s.department}</div>
                                {s.submitted ? (
                                    <div className="text-green-600 font-bold text-sm"><i className="fas fa-check-circle mr-1"></i>ì œì¶œì™„ë£Œ</div>
                                ) : (
                                    <>
                                        <div className="text-red-400 font-bold text-sm mb-1"><i className="fas fa-times-circle mr-1"></i>ë¯¸ì œì¶œ</div>
                                        <button 
                                            onClick={() => handleSendEmail(s.department)}
                                            className="text-xs bg-red-100 text-red-600 px-2 py-1 rounded hover:bg-red-200 w-full"
                                        >
                                            <i className="fas fa-envelope mr-1"></i>ë…ë ¤ ë©”ì¼
                                        </button>
                                    </>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // --- Settings View (Master Only) ---
        const SettingsView = ({ availableYears, setAvailableYears }) => {
            const [newYear, setNewYear] = useState('');

            const handleAddYear = async () => {
                if (!newYear || availableYears.includes(newYear)) return;
                const updated = [...availableYears, newYear].sort();
                setAvailableYears(updated);
                await setDoc(doc(db, "system_settings", "config"), { years: updated });
                setNewYear('');
            };

            const handleRemoveYear = async (year) => {
                if (availableYears.length <= 1) return alert("ìµœì†Œ 1ê°œì˜ ì—°ë„ëŠ” í•„ìš”í•©ë‹ˆë‹¤.");
                const updated = availableYears.filter(y => y !== year);
                setAvailableYears(updated);
                await setDoc(doc(db, "system_settings", "config"), { years: updated });
            };

            return (
                <div className="bg-white p-8 rounded-xl shadow animate-fade-in-up">
                    <h2 className="text-2xl font-bold text-gray-800 mb-6 border-b pb-2"><i className="fas fa-cog mr-2"></i>ì‹œìŠ¤í…œ ì„¤ì •</h2>
                    <div className="mb-8">
                        <h3 className="font-bold text-lg mb-4 text-gray-700">ğŸ“… ì¡°íšŒ ì—°ë„ ê´€ë¦¬</h3>
                        <div className="flex gap-2 mb-4">
                            <input type="number" className="border rounded px-4 py-2 w-48" placeholder="ì˜ˆ: 2027" value={newYear} onChange={e => setNewYear(e.target.value)} />
                            <button onClick={handleAddYear} className="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">ì¶”ê°€</button>
                        </div>
                        <div className="flex flex-wrap gap-2">
                            {availableYears.map(year => (
                                <div key={year} className="bg-gray-100 px-4 py-2 rounded-full flex items-center gap-2 border">
                                    <span className="font-bold">{year}ë…„</span>
                                    <button onClick={() => handleRemoveYear(year)} className="text-red-400 hover:text-red-600"><i className="fas fa-times-circle"></i></button>
                                </div>
                            ))}
                        </div>
                        <p className="text-sm text-gray-400 mt-2">* ì´ê³³ì—ì„œ ì„¤ì •í•œ ì—°ë„ë§Œ ëŒ€ì‹œë³´ë“œì™€ ì´ë ¥ ì¡°íšŒ í•„í„°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                    </div>
                </div>
            );
        };

        // --- View Components ---
        const LoginView = ({ loginId, setLoginId, loginPw, setLoginPw, handleLogin, saveId, setSaveId, loading }) => (
            <div className="min-h-screen flex items-center justify-center bg-slate-100">
                <div className="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md border-t-4 border-indigo-600">
                    <div className="text-center mb-8">
                        <div className="w-16 h-16 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl"><i className="fas fa-shield-alt"></i></div>
                        <h2 className="text-2xl font-bold text-gray-800">Smart TBM System</h2>
                        <p className="text-gray-500 mt-2 text-sm">ì•ˆì „í•œ ì‘ì—…ì„ ìœ„í•œ ì²«ê±¸ìŒ</p>
                    </div>
                    <form onSubmit={handleLogin} className="space-y-6">
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">ì•„ì´ë”” (ë¶€ì„œì½”ë“œ)</label>
                            <input type="text" className="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-indigo-500 transition outline-none" placeholder="admin or dept_id" value={loginId} onChange={e => setLoginId(e.target.value)} required />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">ë¹„ë°€ë²ˆí˜¸</label>
                            <input type="password" className="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-indigo-500 transition outline-none" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" value={loginPw} onChange={e => setLoginPw(e.target.value)} required />
                        </div>
                        <div className="flex items-center">
                            <input id="saveId" type="checkbox" className="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" checked={saveId} onChange={e => setSaveId(e.target.checked)} />
                            <label htmlFor="saveId" className="ml-2 block text-sm text-gray-900">ì•„ì´ë”” ì €ì¥</label>
                        </div>
                        <button type="submit" className="w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 transition font-bold shadow-lg transform active:scale-95">{loading ? <i className="fas fa-spinner fa-spin"></i> : 'ë¡œê·¸ì¸'}</button>
                    </form>
                </div>
            </div>
        );

        const Sidebar = ({ user, view, setView, handleLogout }) => (
            <div className="w-64 bg-slate-900 text-white h-screen fixed left-0 top-0 flex flex-col shadow-2xl z-20">
                <div className="p-6 border-b border-slate-700">
                    <h1 className="text-xl font-bold tracking-wider text-yellow-400"><i className="fas fa-hard-hat mr-2"></i>Smart TBM</h1>
                    <p className="text-xs text-slate-400 mt-1">Enterprise EHS System</p>
                </div>
                <div className="p-4 border-b border-slate-800 bg-slate-800 bg-opacity-50">
                    <div className="flex items-center space-x-3">
                        <div className="w-10 h-10 rounded-full bg-indigo-500 flex items-center justify-center text-lg font-bold">{user.department.substring(0,1)}</div>
                        <div>
                            <p className="font-medium text-sm">{user.department}</p>
                            <p className="text-xs text-slate-400 capitalize">{user.role}</p>
                        </div>
                    </div>
                </div>
                <nav className="flex-1 p-4 space-y-2 mt-2">
                    <button onClick={() => setView('dashboard')} className={`w-full text-left p-3 rounded-lg flex items-center transition ${view === 'dashboard' ? 'bg-indigo-600 text-white' : 'text-slate-400 hover:bg-slate-800 hover:text-white'}`}><i className="fas fa-chart-pie w-6"></i> ëŒ€ì‹œë³´ë“œ</button>
                    <button onClick={() => setView('write')} className={`w-full text-left p-3 rounded-lg flex items-center transition ${view === 'write' ? 'bg-indigo-600 text-white' : 'text-slate-400 hover:bg-slate-800 hover:text-white'}`}><i className="fas fa-edit w-6"></i> TBM ë“±ë¡</button>
                    <button onClick={() => setView('list')} className={`w-full text-left p-3 rounded-lg flex items-center transition ${view === 'list' ? 'bg-indigo-600 text-white' : 'text-slate-400 hover:bg-slate-800 hover:text-white'}`}><i className="fas fa-list-alt w-6"></i> TBM ì´ë ¥ì¡°íšŒ</button>
                    {user.role === 'master' && (
                        <>
                            <div className="my-4 border-t border-slate-700"></div>
                            <button onClick={() => setView('admin')} className={`w-full text-left p-3 rounded-lg flex items-center transition ${view === 'admin' ? 'bg-pink-600 text-white' : 'text-pink-400 hover:bg-slate-800 hover:text-white'}`}><i className="fas fa-users-cog w-6"></i> ê³„ì •/ê¶Œí•œ ê´€ë¦¬</button>
                            <button onClick={() => setView('settings')} className={`w-full text-left p-3 rounded-lg flex items-center transition ${view === 'settings' ? 'bg-gray-600 text-white' : 'text-gray-400 hover:bg-slate-800 hover:text-white'}`}><i className="fas fa-cog w-6"></i> ì‹œìŠ¤í…œ ì„¤ì •</button>
                        </>
                    )}
                </nav>
                <div className="p-4 border-t border-slate-700">
                    <button onClick={handleLogout} className="w-full py-2 px-4 border border-slate-600 rounded text-slate-300 hover:bg-slate-700 transition flex items-center justify-center text-sm"><i className="fas fa-sign-out-alt mr-2"></i> ë¡œê·¸ì•„ì›ƒ</button>
                </div>
            </div>
        );

        const DashboardView = ({ stats, tbms, currentYear, setCurrentYear, allTbms, availableYears }) => {
            const riskCategoryData = useMemo(() => {
                const risks = {};
                tbms.forEach(tbm => tbm.risks?.forEach(r => {
                    const key = (r.factor || "ê¸°íƒ€").split(' ')[0] || "ê¸°íƒ€";
                    risks[key] = (risks[key] || 0) + 1;
                }));
                return Object.entries(risks).map(([label, value]) => ({label, value}));
            }, [tbms]);

            const safetyScore = useMemo(() => {
                if (stats.total === 0) return 0;
                return Math.round((stats.safeCount / stats.total) * 100);
            }, [stats]);

            const getScoreMessage = (score) => {
                if (stats.total === 0) return "ë°ì´í„°ê°€ ìˆ˜ì§‘ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
                if (score >= 90) return "í›Œë¥­í•©ë‹ˆë‹¤! í˜„ì¬ ìµœê³  ìˆ˜ì¤€ì˜ ì•ˆì „ ê´€ë¦¬ê°€ ì´ë£¨ì–´ì§€ê³  ìˆìŠµë‹ˆë‹¤.";
                if (score >= 70) return "ì–‘í˜¸í•©ë‹ˆë‹¤. ì§€ì†ì ì¸ ìœ„í—˜ ìš”ì¸ ë°œêµ´ê³¼ ê´€ì‹¬ì´ í•„ìš”í•©ë‹ˆë‹¤.";
                return "ì£¼ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤. ìœ„í—˜ì„± í‰ê°€ ì‹¤ì‹œìœ¨ì„ ë†’ì´ê³  ì•ˆì „ ì¡°ì¹˜ë¥¼ ê°•í™”í•´ì£¼ì„¸ìš”.";
            };

            return (
                <div className="space-y-6 animate-fade-in-up">
                    <div className="flex justify-between items-end">
                        <div>
                            <h2 className="text-2xl font-bold text-gray-800">EHS ê²½ì˜ ëŒ€ì‹œë³´ë“œ</h2>
                            <p className="text-gray-500">ì‹¤ì‹œê°„ ì•ˆì „ í™œë™ í˜„í™© ë¦¬í¬íŠ¸</p>
                        </div>
                        <div className="flex items-center gap-3">
                             <select className="bg-white border border-gray-300 text-gray-700 py-1 px-3 rounded-lg font-bold" value={currentYear} onChange={(e) => setCurrentYear(e.target.value)}>
                                {availableYears.map(y => <option key={y} value={y}>{y}ë…„</option>)}
                            </select>
                            <span className="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-xs font-bold">{new Date().toLocaleDateString()} ê¸°ì¤€</span>
                        </div>
                    </div>

                    {/* Row 1: KPI Cards */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <KPICard title={`${currentYear}ë…„ ì´ TBM ìˆ˜í–‰`} value={`${stats.total}íšŒ`} icon="fa-clipboard-check" color="bg-blue-500" subtext="ì „ë…„ ë™ê¸° ëŒ€ë¹„ 12% ì¦ê°€" />
                        <KPICard title="ìœ„í—˜ì„± í‰ê°€ ì‹¤ì‹œìœ¨" value={`${stats.total ? Math.round((stats.safeCount/stats.total)*100) : 0}%`} icon="fa-shield-virus" color="bg-green-500" subtext="ëª©í‘œì¹˜ 95% ë‹¬ì„± ì¤‘" />
                        <KPICard title="ì°¸ì—¬ ì‘ì—…ì ìˆ˜" value={`${tbms.reduce((acc, cur) => acc + (cur.attendees?.length || 0), 0)}ëª…`} icon="fa-users" color="bg-purple-500" subtext="ê¸ˆì¼ í˜„ì¥ íˆ¬ì… ì¸ì›" />
                    </div>

                    {/* Row 2: Monthly Activity (Full Width for 12 months) */}
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <h3 className="font-bold text-gray-700 mb-4 border-l-4 border-indigo-500 pl-3">ì›”ë³„ TBM í™œë™ ì¶”ì´ (ì—°ê°„)</h3>
                        <SimpleBarChart data={stats.monthlyData} />
                    </div>

                    {/* Row 3: Safety Index & Risk Analysis */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        {/* Safety Index (Moved from Row 2) */}
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 text-center">
                            <h3 className="font-bold text-gray-700 mb-2 border-l-4 border-green-500 pl-3 text-left">ì¢…í•© ì•ˆì „ ì§€ìˆ˜</h3>
                            <RiskGauge score={safetyScore} />
                            <div className="mt-4 p-3 bg-gray-50 rounded text-left text-sm text-gray-600">
                                <i className="fas fa-quote-left mr-2 text-gray-400"></i>
                                {getScoreMessage(safetyScore)}
                            </div>
                        </div>
                        {/* Risk Analysis (Kept here) */}
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                            <h3 className="font-bold text-gray-700 mb-4 border-l-4 border-orange-500 pl-3">ìœ„í—˜ ìš”ì¸ ìœ í˜• ë¶„ì„</h3>
                            <DonutChart data={riskCategoryData} />
                        </div>
                    </div>
                </div>
            );
        };

        const ListView = ({ user, myTbms, setView, accounts, allTbms, currentYear, setCurrentYear, onEdit, onDelete, onPdfDownload, availableYears }) => {
            return (
                <div className="bg-white rounded-xl shadow border border-gray-200 animate-fade-in-up">
                    <div className="p-6 border-b border-gray-100 flex justify-between items-center">
                        <div>
                            <h2 className="text-xl font-bold text-gray-800">TBM ì´ë ¥ ì¡°íšŒ</h2>
                            <p className="text-sm text-gray-500">{user.role === 'master' ? 'ì „ì‚¬ í†µí•© ê´€ë¦¬ ëª¨ë“œ' : `${user.department} í™œë™ ë‚´ì—­`}</p>
                        </div>
                        <div className="flex gap-2">
                            <select className="bg-gray-50 border border-gray-300 text-gray-700 py-1 px-3 rounded shadow-sm" value={currentYear} onChange={(e) => setCurrentYear(e.target.value)}>
                                {availableYears.map(y => <option key={y} value={y}>{y}ë…„</option>)}
                            </select>
                            <button onClick={() => setView('write')} className="bg-indigo-600 text-white px-4 py-2 rounded shadow hover:bg-indigo-700 text-sm"><i className="fas fa-plus mr-1"></i> ì‹ ê·œ ë“±ë¡</button>
                        </div>
                    </div>
                    
                    {/* Weekly Status Panel (Sorted by Dept Name) */}
                    {user.role === 'master' && (
                        <div className="px-6 pt-6">
                            <WeeklyStatusPanel accounts={accounts} tbms={allTbms} currentYear={currentYear} />
                        </div>
                    )}

                    <div className="overflow-x-auto">
                        <table className="w-full text-left border-collapse">
                            <thead>
                                <tr className="bg-gray-50 text-gray-500 text-sm uppercase tracking-wider">
                                    <th className="p-4 font-medium">ê¸°ê°„ (ì£¼ì°¨)</th>
                                    <th className="p-4 font-medium">ë¶€ì„œ</th>
                                    <th className="p-4 font-medium">ì‘ì—…ëª…</th>
                                    <th className="p-4 font-medium">ë¦¬ë”</th>
                                    <th className="p-4 font-medium text-center">ê´€ë¦¬</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-100">
                                {myTbms.length === 0 ? (
                                    <tr><td colSpan="5" className="p-8 text-center text-gray-400">{currentYear}ë…„ë„ ë“±ë¡ëœ TBM ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                                ) : myTbms.map(tbm => (
                                    <tr key={tbm.id} className="hover:bg-gray-50 transition">
                                        <td className="p-4 text-sm text-gray-600 font-bold">{getFormattedWeek(tbm.date)}<div className="text-xs text-gray-400 font-normal">{tbm.date}</div></td>
                                        <td className="p-4 text-sm font-bold text-indigo-600">{tbm.department}</td>
                                        <td className="p-4 text-sm font-medium text-gray-800">{tbm.workName}</td>
                                        <td className="p-4 text-sm text-gray-600">{tbm.leader}</td>
                                        <td className="p-4 text-center">
                                            <div className="flex justify-center gap-2">
                                                <button onClick={() => onEdit(tbm)} className="text-indigo-500 hover:bg-indigo-50 p-2 rounded text-xs border border-indigo-200"><i className="fas fa-edit"></i> ìˆ˜ì •</button>
                                                <button onClick={() => onDelete(tbm.id)} className="text-red-500 hover:bg-red-50 p-2 rounded text-xs border border-red-200"><i className="fas fa-trash"></i> ì‚­ì œ</button>
                                                {user.role === 'master' && (
                                                    <button onClick={() => onPdfDownload(tbm)} className="text-green-600 hover:bg-green-50 p-2 rounded text-xs border border-green-200"><i className="fas fa-file-pdf"></i> PDF</button>
                                                )}
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const AdminView = ({ accounts, showToast }) => {
            const [newAcc, setNewAcc] = useState({ username: '', password: '', department: 'ìƒì‚°íŒ€', role: 'user' });
            const [editingId, setEditingId] = useState(null);
            const [newPassword, setNewPassword] = useState('');

            const handleCreateAccount = async () => {
                if(!newAcc.username || !newAcc.password) return showToast('ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'error');
                try {
                    await addDoc(collection(db, "app_users"), newAcc);
                    showToast('ê³„ì •ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                    setNewAcc({ username: '', password: '', department: 'ìƒì‚°íŒ€', role: 'user' });
                } catch(e) { showToast('ìƒì„± ì‹¤íŒ¨', 'error'); }
            };
            const handleDeleteAccount = async (id) => { if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) await deleteDoc(doc(db, "app_users", id)); };
            const handleUpdatePassword = async (id) => {
                if(!newPassword) return;
                await updateDoc(doc(db, "app_users", id), { password: newPassword });
                showToast('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì™„ë£Œ', 'success');
                setEditingId(null);
            };

            const sortedAccounts = [...accounts].sort((a, b) => (a.department || '').localeCompare(b.department || '', 'ko'));

            return (
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 animate-fade-in-up">
                    <div className="lg:col-span-1 bg-white p-6 rounded-xl shadow h-fit">
                        <h3 className="font-bold text-lg mb-4 text-gray-800">ìƒˆ ê³„ì • ìƒì„±</h3>
                        <div className="space-y-4">
                            <input type="text" className="input-field" placeholder="ì•„ì´ë””" value={newAcc.username} onChange={e=>setNewAcc({...newAcc, username: e.target.value})} />
                            <input type="password" className="input-field" placeholder="ë¹„ë°€ë²ˆí˜¸" value={newAcc.password} onChange={e=>setNewAcc({...newAcc, password: e.target.value})} />
                            <input type="text" className="input-field" placeholder="ë¶€ì„œëª…" value={newAcc.department} onChange={e=>setNewAcc({...newAcc, department: e.target.value})} />
                            <select className="input-field" value={newAcc.role} onChange={e=>setNewAcc({...newAcc, role: e.target.value})}>
                                <option value="user">User</option>
                                <option value="master">Master</option>
                            </select>
                            <button onClick={handleCreateAccount} className="w-full bg-pink-600 text-white py-2 rounded font-bold hover:bg-pink-700 transition">ê³„ì • ìƒì„±</button>
                        </div>
                    </div>
                    <div className="lg:col-span-2 bg-white p-6 rounded-xl shadow">
                        <h3 className="font-bold text-lg mb-4 text-gray-800">ë“±ë¡ëœ ê³„ì • ëª©ë¡ (ê°€ë‚˜ë‹¤ìˆœ)</h3>
                        <div className="grid gap-3">
                            {sortedAccounts.map(acc => (
                                <div key={acc.id} className="flex flex-col sm:flex-row justify-between items-center p-3 border rounded hover:bg-gray-50 gap-3">
                                    <div className="flex-1"><span className="font-bold text-gray-700">{acc.department}</span> ({acc.username})</div>
                                    <div className="flex items-center gap-2">
                                        {editingId === acc.id ? (
                                            <div className="flex gap-1">
                                                <input type="text" className="border rounded px-2 py-1 text-sm w-32" value={newPassword} onChange={e=>setNewPassword(e.target.value)} />
                                                <button onClick={()=>handleUpdatePassword(acc.id)} className="bg-green-500 text-white px-2 py-1 rounded text-xs">ì €ì¥</button>
                                                <button onClick={()=>{setEditingId(null); setNewPassword('')}} className="bg-gray-300 text-white px-2 py-1 rounded text-xs">ì·¨ì†Œ</button>
                                            </div>
                                        ) : <button onClick={()=>{setEditingId(acc.id); setNewPassword('')}} className="text-indigo-500 border border-indigo-200 px-3 py-1 rounded text-sm">ë¹„ë²ˆë³€ê²½</button>}
                                        <button onClick={() => handleDeleteAccount(acc.id)} className="text-red-500 border border-red-200 px-3 py-1 rounded text-sm">ì‚­ì œ</button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const TBMFormView = ({ user, setView, showToast, setLoading, initialData }) => {
            const [form, setForm] = useState(initialData || {
                date: new Date().toISOString().split('T')[0],
                startTime: '09:00',
                endTime: '18:00',
                temperature: '',
                humidity: '',
                workName: '',
                workDesc: '',
                location: '',
                riskAssessmentDone: false,
                risks: [{ id: 1, factor: '', measure: '' }],
                keyRiskId: '',
                leader: user.username,
                preChecks: { check1: false, check2: false, check3: false },
                safetyActionChecks: [{ risk: '', result: 'yes', action: '' }],
                dailyCheckResult: 'íŠ¹ì´ì‚¬í•­ ì—†ìŒ',
                photoUrl: '',
                attendees: [{ name: '', signed: false, signatureUrl: '' }]
            });
            const [showSignModal, setShowSignModal] = useState(false);
            const [currentSignerIndex, setCurrentSignerIndex] = useState(null);

            const addRiskRow = () => setForm(p => ({...p, risks: [...p.risks, { id: Date.now(), factor: '', measure: '' }]}));
            const updateRisk = (id, f, v) => setForm(p => ({...p, risks: p.risks.map(r => r.id===id ? {...r, [f]: v} : r)}));
            const removeRisk = (id) => setForm(p => ({...p, risks: p.risks.filter(r => r.id !== id)}));
            const addAttendee = () => setForm(p => ({...p, attendees: [...p.attendees, { name: '', signed: false, signatureUrl: '' }]}));
            
            const removeAttendee = (idx) => {
                const newAtt = form.attendees.filter((_, i) => i !== idx);
                setForm({ ...form, attendees: newAtt });
            };

            const updateAttendee = (idx, name) => {
                const newAtt = [...form.attendees];
                newAtt[idx].name = name;
                setForm({...form, attendees: newAtt});
            };
            const openSignModal = (idx) => {
                if (!form.attendees[idx].name) return showToast("ì´ë¦„ì„ ë¨¼ì € ì…ë ¥í•˜ì„¸ìš”.", "error");
                setCurrentSignerIndex(idx);
                setShowSignModal(true);
            };
            const handleSaveSignature = (dataUrl) => {
                const newAtt = [...form.attendees];
                newAtt[currentSignerIndex].signed = true;
                newAtt[currentSignerIndex].signatureUrl = dataUrl;
                setForm({ ...form, attendees: newAtt });
            };
            
            const syncRisksToActions = () => {
                const newActions = form.risks.filter(r => r.factor.trim() !== '').map(r => ({
                    risk: r.factor,
                    result: 'yes',
                    action: ''
                }));
                if (newActions.length === 0) return showToast("ì…ë ¥ëœ ì ì¬ìœ„í—˜ìš”ì¸ì´ ì—†ìŠµë‹ˆë‹¤.", "info");
                setForm(prev => ({...prev, safetyActionChecks: newActions}));
                showToast("ìœ„í—˜ìš”ì¸ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.", "success");
            };
            const updateActionCheck = (idx, f, v) => {
                const newChecks = [...form.safetyActionChecks];
                newChecks[idx][f] = v;
                setForm({...form, safetyActionChecks: newChecks});
            };

            const handlePhotoUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        setForm(prev => ({...prev, photoUrl: reader.result}));
                    };
                    reader.readAsDataURL(file);
                }
            };

            // --- NEW FUNCTION: Load Last Data ---
            const handleLoadRecentData = async () => {
                setLoading(true);
                try {
                    // 1. Query only by department to avoid composite index requirement
                    const q = query(collection(db, "global_tbm_data"), where("department", "==", user.department));
                    const snapshot = await getDocs(q);
                    
                    if (snapshot.empty) {
                        showToast("ë¶ˆëŸ¬ì˜¬ ì´ì „ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.", "info");
                        setLoading(false);
                        return;
                    }

                    // 2. Sort client-side (Descending by date/createdAt)
                    const sortedDocs = snapshot.docs.map(d => d.data()).sort((a, b) => {
                        const dateA = new Date(a.createdAt || a.date);
                        const dateB = new Date(b.createdAt || b.date);
                        return dateB - dateA;
                    });
                    
                    const recentData = sortedDocs[0]; // Get the most recent one

                    // 3. Merge Data (Keep Date/Time, Overwrite Content)
                    setForm(prev => ({
                        ...prev,
                        workName: recentData.workName || '',
                        workDesc: recentData.workDesc || '',
                        location: recentData.location || '',
                        // Reset Env info as it changes daily
                        temperature: '', 
                        humidity: '',
                        // Copy Risks (Deep copy to avoid ref issues)
                        risks: recentData.risks ? JSON.parse(JSON.stringify(recentData.risks)) : [],
                        keyRiskId: recentData.keyRiskId || '', 
                        // Copy Safety Checks (Reset results to 'yes')
                        safetyActionChecks: recentData.safetyActionChecks ? recentData.safetyActionChecks.map(c => ({ risk: c.risk, result: 'yes', action: '' })) : [],
                        // Copy Attendees (Names ONLY, clear signatures)
                        attendees: recentData.attendees ? recentData.attendees.map(a => ({ name: a.name, signed: false, signatureUrl: '' })) : [],
                        // Reset Daily Check
                        dailyCheckResult: 'íŠ¹ì´ì‚¬í•­ ì—†ìŒ',
                        // Reset Photo
                        photoUrl: ''
                    }));

                    showToast("ìµœê·¼ ì‘ì—… ë‚´ìš©ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.", "success");

                } catch (error) {
                    console.error("Load Data Error:", error);
                    showToast("ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "error");
                } finally {
                    setLoading(false);
                }
            };

            const handleSubmit = async () => {
                if(!form.workName || !form.location) return showToast("í•„ìˆ˜ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.", "error");
                setLoading(true);
                try {
                    const selectedRisk = form.risks.find(r => r.id == form.keyRiskId);
                    const docData = {
                        ...form,
                        department: user.department,
                        keyRiskFactor: selectedRisk ? selectedRisk.factor : 'N/A',
                        keyRiskMeasure: selectedRisk ? selectedRisk.measure : 'N/A',
                        updatedAt: new Date().toISOString()
                    };
                    if (!initialData) {
                        docData.createdBy = user.username;
                        docData.createdAt = new Date().toISOString();
                        await addDoc(collection(db, "global_tbm_data"), docData);
                        showToast("ë“±ë¡ ì™„ë£Œ", "success");
                    } else {
                        await updateDoc(doc(db, "global_tbm_data", initialData.id), docData);
                        showToast("ìˆ˜ì • ì™„ë£Œ", "success");
                    }
                    setView('list');
                } catch (err) { showToast("ì˜¤ë¥˜ ë°œìƒ", "error"); }
                setLoading(false);
            };

            return (
                <div className="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden max-w-4xl mx-auto animate-fade-in-up">
                    <div className="bg-gray-800 text-white p-4 flex justify-between items-center">
                        <div className="flex items-center gap-4">
                            <h2 className="text-xl font-bold"><i className="fas fa-edit mr-2"></i>{initialData ? "TBM ìˆ˜ì •" : "TBM ë“±ë¡"}</h2>
                            {/* NEW BUTTON: Load Recent Data (Only visible in Create mode) */}
                            {!initialData && (
                                <button 
                                    onClick={handleLoadRecentData}
                                    className="bg-indigo-600 hover:bg-indigo-500 text-white text-xs px-3 py-1.5 rounded-full font-bold transition flex items-center shadow-md border border-indigo-400"
                                    title="ê°€ì¥ ìµœê·¼ì— ì‘ì„±í•œ TBM ë‚´ìš© ë¶ˆëŸ¬ì˜¤ê¸°"
                                >
                                    <i className="fas fa-history mr-1"></i>ìµœê·¼ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
                                </button>
                            )}
                        </div>
                        <span className="text-sm bg-gray-700 px-3 py-1 rounded">{user.department}</span>
                    </div>
                    <div className="p-8 space-y-8">
                        <section>
                            <h3 className="text-lg font-bold text-gray-700 mb-4 border-b pb-2">1. ì‘ì—… ê°œìš”</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label className="label-text">ì¼ì‹œ</label>
                                    <div className="flex gap-2 items-center flex-wrap">
                                        <input type="date" className="input-field flex-grow" value={form.date} onChange={e=>setForm({...form, date:e.target.value})} />
                                        <div className="flex items-center gap-1">
                                            <input type="time" className="input-field w-24" value={form.startTime} onChange={e=>setForm({...form, startTime:e.target.value})} />
                                            <span>~</span>
                                            <input type="time" className="input-field w-24" value={form.endTime} onChange={e=>setForm({...form, endTime:e.target.value})} />
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <label className="label-text">ì¥ì†Œ</label>
                                    <input type="text" className="input-field" value={form.location} onChange={e=>setForm({...form, location:e.target.value})} />
                                </div>
                                <div className="flex gap-4 md:col-span-2">
                                    <div className="flex-1">
                                        <label className="label-text">ì˜¨ë„ (â„ƒ)</label>
                                        <input type="number" className="input-field" placeholder="ì˜ˆ: 25" value={form.temperature} onChange={e=>setForm({...form, temperature:e.target.value})} />
                                    </div>
                                    <div className="flex-1">
                                        <label className="label-text">ìŠµë„ (%)</label>
                                        <input type="number" className="input-field" placeholder="ì˜ˆ: 50" value={form.humidity} onChange={e=>setForm({...form, humidity:e.target.value})} />
                                    </div>
                                </div>
                                <div className="md:col-span-2"><label className="label-text">ì‘ì—…ëª…</label><input type="text" className="input-field" value={form.workName} onChange={e=>setForm({...form, workName:e.target.value})} /></div>
                                <div className="md:col-span-2">
                                    <label className="label-text flex items-center justify-between">ë‚´ìš© <i className="fas fa-microphone text-gray-400 hover:text-indigo-500 cursor-pointer" title="ìŒì„± ì…ë ¥ (ì§€ì› ì˜ˆì •)"></i></label>
                                    <textarea className="input-field h-20" value={form.workDesc} onChange={e=>setForm({...form, workDesc:e.target.value})}></textarea>
                                </div>
                            </div>
                        </section>
                        <section className="bg-yellow-50 p-6 rounded-lg border border-yellow-200">
                             <div className="flex justify-between items-center mb-4">
                                <h3 className="text-lg font-bold text-yellow-800">2. ìœ„í—˜ì„± í‰ê°€</h3>
                                <div className="flex items-center gap-2"><span className="text-sm font-bold">ì‹¤ì‹œì—¬ë¶€</span><input type="checkbox" className="w-5 h-5" checked={form.riskAssessmentDone} onChange={e=>setForm({...form, riskAssessmentDone: e.target.checked})} /></div>
                            </div>
                            <div className="space-y-2">
                                {form.risks.map((risk, idx) => (
                                    <div key={risk.id} className="grid grid-cols-12 gap-2 items-center">
                                        <div className="col-span-1 text-center font-bold bg-white rounded-full w-6 h-6">{idx+1}</div>
                                        <div className="col-span-5"><input type="text" className="input-field py-1 text-sm" placeholder="ìœ„í—˜ìš”ì¸" value={risk.factor} onChange={e=>updateRisk(risk.id, 'factor', e.target.value)} /></div>
                                        <div className="col-span-5"><input type="text" className="input-field py-1 text-sm" placeholder="ëŒ€ì±…" value={risk.measure} onChange={e=>updateRisk(risk.id, 'measure', e.target.value)} /></div>
                                        <div className="col-span-1 text-center"><button onClick={()=>removeRisk(risk.id)} className="text-red-400"><i className="fas fa-times"></i></button></div>
                                    </div>
                                ))}
                                <button onClick={addRiskRow} className="w-full py-2 border-2 border-dashed border-gray-300 text-gray-500 rounded text-sm hover:bg-white">+ ìœ„í—˜ìš”ì¸ ì¶”ê°€</button>
                            </div>
                            <div className="mt-4"><label className="label-text text-red-600 font-bold">ì¤‘ì  ìœ„í—˜ìš”ì¸ ì„ íƒ</label><select className="input-field" value={form.keyRiskId} onChange={e=>setForm({...form, keyRiskId: e.target.value})}><option value="">ì„ íƒí•˜ì„¸ìš”</option>{form.risks.map((r,i)=>(<option key={r.id} value={r.id}>{i+1}. {r.factor}</option>))}</select></div>
                        </section>
                        
                        <section className="bg-blue-50 p-6 rounded-lg border border-blue-200">
                            <div className="flex justify-between items-center mb-4">
                                <h3 className="text-lg font-bold text-blue-800">3. ì‘ì—… ì „ ì•ˆì „ì¡°ì¹˜ í™•ì¸</h3>
                                <button onClick={syncRisksToActions} className="bg-white border border-blue-300 text-blue-600 text-xs px-3 py-1 rounded hover:bg-blue-100 font-bold"><i className="fas fa-sync mr-1"></i>ìœ„í—˜ìš”ì¸ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                            </div>
                            <div className="space-y-3">
                                <div className="grid grid-cols-12 gap-2 text-xs font-bold text-gray-500 text-center">
                                    <div className="col-span-5">ìœ„í—˜ìš”ì†Œ</div>
                                    <div className="col-span-2">ì¡°ì¹˜ì—¬ë¶€</div>
                                    <div className="col-span-5">ë¯¸ì¡°ì¹˜ ì‹œ ë‚´ìš©</div>
                                </div>
                                {form.safetyActionChecks && form.safetyActionChecks.map((check, idx) => (
                                    <div key={idx} className="grid grid-cols-12 gap-2 items-center bg-white p-2 rounded border border-blue-100">
                                        <div className="col-span-5 text-sm font-bold text-gray-700">{check.risk || 'ì…ë ¥ í•„ìš”'}</div>
                                        <div className="col-span-2 text-center">
                                            <select className="border rounded py-1 text-xs" value={check.result} onChange={e=>updateActionCheck(idx, 'result', e.target.value)}>
                                                <option value="yes">ì˜ˆ</option>
                                                <option value="no">ì•„ë‹ˆì˜¤</option>
                                            </select>
                                        </div>
                                        <div className="col-span-5">
                                            <input type="text" className="input-field py-1 text-xs" placeholder="ë‚´ìš© ì…ë ¥" value={check.action} onChange={e=>updateActionCheck(idx, 'action', e.target.value)} disabled={check.result === 'yes'} />
                                        </div>
                                    </div>
                                ))}
                                {(!form.safetyActionChecks || form.safetyActionChecks.length === 0) && <div className="text-center text-gray-400 text-sm py-4">ìœ„í—˜ìš”ì¸ ë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>}
                            </div>
                        </section>

                        <section className="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div>
                                <h3 className="text-lg font-bold text-gray-700 mb-4 border-b pb-2">4. ì‘ì—… ì „ ì•ˆì „ ì ê²€ (Checklist)</h3>
                                <div className="space-y-2 mb-6">
                                    <label className="flex items-center p-2 border rounded bg-white"><input type="checkbox" className="mr-2" checked={form.preChecks.check1} onChange={e=>setForm({...form, preChecks:{...form.preChecks, check1:e.target.checked}})} />ë³´í˜¸êµ¬ ì°©ìš©</label>
                                    <label className="flex items-center p-2 border rounded bg-white"><input type="checkbox" className="mr-2" checked={form.preChecks.check2} onChange={e=>setForm({...form, preChecks:{...form.preChecks, check2:e.target.checked}})} />ì¥ë¹„ ì ê²€</label>
                                    <label className="flex items-center p-2 border rounded bg-white"><input type="checkbox" className="mr-2" checked={form.preChecks.check3} onChange={e=>setForm({...form, preChecks:{...form.preChecks, check3:e.target.checked}})} />ê±´ê°• ìƒíƒœ</label>
                                </div>
                                <h3 className="text-lg font-bold text-gray-700 mb-4 border-b pb-2">ì‘ì—… ì „ ì¼ì¼ ì•ˆì „ì ê²€ ì‹œí–‰ ê²°ê³¼</h3>
                                <textarea className="input-field h-24" placeholder="íŠ¹ì´ì‚¬í•­ ì—†ìŒ" value={form.dailyCheckResult} onChange={e=>setForm({...form, dailyCheckResult:e.target.value})}></textarea>
                            </div>
                            <div>
                                <h3 className="text-lg font-bold text-gray-700 mb-4 border-b pb-2">5. ì°¸ì„ì ({form.attendees.length}ëª…)</h3>
                                <div className="bg-gray-50 p-4 rounded h-40 overflow-y-auto space-y-2 mb-4">
                                    {form.attendees.map((att, idx) => (
                                        <div key={idx} className="flex items-center gap-2 bg-white p-2 rounded border shadow-sm">
                                            <input type="text" placeholder="ì´ë¦„" className="border border-gray-300 rounded px-3 py-2 text-sm flex-1 text-center font-bold outline-none focus:ring-2 focus:ring-indigo-500 h-12" value={att.name} onChange={e=>updateAttendee(idx, e.target.value)} disabled={att.signed} />
                                            <div onClick={()=>!att.signed && openSignModal(idx)} className={`flex-1 h-12 border rounded flex items-center justify-center cursor-pointer transition ${att.signed ? 'bg-white border-indigo-500' : 'bg-gray-50 border-dashed hover:bg-indigo-50'}`}>
                                                {att.signed && att.signatureUrl ? <img src={att.signatureUrl} alt="ì„œëª…" className="h-full object-contain" /> : <span className="text-sm text-gray-400 font-bold whitespace-nowrap"><i className="fas fa-file-signature mr-1"></i>í„°ì¹˜í•˜ì—¬ ì„œëª…</span>}
                                            </div>
                                            <button onClick={() => removeAttendee(idx)} className="w-8 h-8 flex items-center justify-center text-red-400 hover:text-red-600 hover:bg-red-50 rounded-full transition" title="ì°¸ì„ì ì‚­ì œ">
                                                <i className="fas fa-minus-circle"></i>
                                            </button>
                                        </div>
                                    ))}
                                    <button onClick={addAttendee} className="w-full py-2 bg-indigo-50 text-indigo-600 font-bold rounded text-sm hover:bg-indigo-100">+ ì¶”ê°€</button>
                                </div>
                                <h3 className="text-lg font-bold text-gray-700 mb-4 border-b pb-2">6. TBM í™œë™ ì‚¬ì§„ ì²¨ë¶€</h3>
                                <div className="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:bg-gray-50 transition relative">
                                    <input type="file" accept="image/*" onChange={handlePhotoUpload} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
                                    {form.photoUrl ? (
                                        <img src={form.photoUrl} alt="Preview" className="max-h-32 mx-auto rounded shadow" />
                                    ) : (
                                        <div className="text-gray-400"><i className="fas fa-camera text-3xl mb-2"></i><br/>í´ë¦­í•˜ì—¬ ì‚¬ì§„ ì´¬ì˜/ì—…ë¡œë“œ</div>
                                    )}
                                </div>
                            </div>
                        </section>
                        <div className="pt-6 border-t flex justify-end gap-4">
                            <button onClick={()=>setView('list')} className="px-6 py-3 border rounded">ì·¨ì†Œ</button>
                            <button onClick={handleSubmit} className="px-8 py-3 bg-indigo-600 text-white rounded font-bold shadow-lg hover:bg-indigo-700">ì €ì¥</button>
                        </div>
                    </div>
                    <SignatureModal isOpen={showSignModal} onClose={()=>setShowSignModal(false)} onSave={handleSaveSignature} signerName={currentSignerIndex!==null?form.attendees[currentSignerIndex].name:''} />
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null); 
            const [view, setView] = useState('login'); 
            const [loading, setLoading] = useState(true);
            const [toast, setToast] = useState(null);
            const [tbms, setTbms] = useState([]);
            const [accounts, setAccounts] = useState([]);
            const [currentYear, setCurrentYear] = useState('2026'); // Default 2026
            const [availableYears, setAvailableYears] = useState(['2026']); // Default Only 2026
            const [loginId, setLoginId] = useState('');
            const [loginPw, setLoginPw] = useState('');
            const [saveId, setSaveId] = useState(false);
            const [editTbmData, setEditTbmData] = useState(null);
            
            // PDF Generation State
            const [downloadingPdf, setDownloadingPdf] = useState(false);
            const [targetPdfTbm, setTargetPdfTbm] = useState(null);

            useEffect(() => {
                const saved = localStorage.getItem('savedId');
                if (saved) { setLoginId(saved); setSaveId(true); }

                const init = async () => {
                    await signInAnonymously(auth);
                    
                    // Fetch System Config
                    const configDoc = await getDoc(doc(db, "system_settings", "config"));
                    if (configDoc.exists()) {
                        setAvailableYears(configDoc.data().years || ['2026']);
                    }

                    // --- Sort Logic Applied Here (Global) ---
                    onSnapshot(query(collection(db, "app_users")), (s) => {
                        const fetchedAccounts = s.docs.map(d => ({id:d.id, ...d.data()}));
                        // Sort by department alphabetically using localeCompare for Korean support
                        fetchedAccounts.sort((a, b) => {
                            const deptA = a.department || '';
                            const deptB = b.department || '';
                            return deptA.localeCompare(deptB, 'ko');
                        });
                        setAccounts(fetchedAccounts);
                    });

                    onSnapshot(query(collection(db, "global_tbm_data"), orderBy("createdAt", "desc")), (s) => {
                        setTbms(s.docs.map(d => ({id:d.id, ...d.data()})));
                        setLoading(false);
                    });
                };
                init();
            }, []);

            const showToast = (msg, type = 'info') => setToast({ message: msg, type });

            const handleLogin = (e) => {
                e.preventDefault();
                setLoading(true);
                if (saveId) localStorage.setItem('savedId', loginId);
                else localStorage.removeItem('savedId');

                // Master Check (Updated Password)
                if (loginId === 'admin' && loginPw === '0908') {
                    const realMaster = accounts.find(a => a.role === 'master');
                    if (!realMaster || accounts.length === 0) {
                        setUser({ id: 'temp_master', username: 'Master Admin', role: 'master', department: 'ê²½ì˜ê¸°íšíŒ€' });
                        setView('dashboard');
                        showToast('ê´€ë¦¬ìë¡œ ë¡œê·¸ì¸í–ˆìŠµë‹ˆë‹¤.', 'success');
                        setLoading(false);
                        return;
                    }
                }
                const foundUser = accounts.find(a => a.username === loginId && a.password === loginPw);
                if (foundUser) {
                    setUser(foundUser);
                    setView('dashboard');
                    showToast('ë¡œê·¸ì¸ ì„±ê³µ', 'success');
                } else {
                    showToast('ì •ë³´ ë¶ˆì¼ì¹˜', 'error');
                }
                setLoading(false);
            };

            const handleEditTbm = (tbm) => {
                setEditTbmData(tbm);
                setView('write');
            };

            const handleDeleteTbm = async (id) => {
                if(confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    await deleteDoc(doc(db, "global_tbm_data", id));
                    showToast("ì‚­ì œ ì™„ë£Œ", "success");
                }
            };
            
            const handlePdfDownload = (tbm) => {
                showToast("PDF ìƒì„±ì„ ì‹œì‘í•©ë‹ˆë‹¤...", "info");
                setTargetPdfTbm(tbm);
                setDownloadingPdf(true);
            };

            const handlePdfComplete = () => {
                setDownloadingPdf(false);
                setTargetPdfTbm(null);
                showToast("PDF ë‹¤ìš´ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
            };

            const handleLogout = () => { setUser(null); setView('login'); setLoginId(''); setLoginPw(''); };

            const myTbms = useMemo(() => {
                if (!user) return [];
                const filtered = tbms.filter(t => t.date.startsWith(currentYear));
                if (user.role === 'master') return filtered;
                return filtered.filter(t => t.department === user.department);
            }, [tbms, user, currentYear]);

            const stats = useMemo(() => {
                const yearTbms = tbms.filter(t => t.date.startsWith(currentYear));
                const total = yearTbms.length;
                const safeCount = yearTbms.filter(t => t.riskAssessmentDone).length;
                const monthlyData = Array.from({length: 12}, (_, i) => ({ label: `${i+1}ì›”`, value: 0 }));
                yearTbms.forEach(t => {
                    if(t.date) monthlyData[new Date(t.date).getMonth()].value++;
                });
                return { total, safeCount, monthlyData: monthlyData }; // REMOVED SLICE
            }, [tbms, currentYear]);

            if (loading && !user && view !== 'login') return <div className="h-screen flex items-center justify-center flex-col"><i className="fas fa-circle-notch fa-spin text-4xl text-indigo-600 mb-4"></i><p>Loading...</p></div>;

            return (
                <div className="flex h-screen overflow-hidden">
                    {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
                    
                    {/* Hidden PDF Generator */}
                    {downloadingPdf && targetPdfTbm && (
                        <PdfHiddenGenerator tbm={targetPdfTbm} onComplete={handlePdfComplete} />
                    )}

                    {view === 'login' ? (
                        <div className="w-full"><LoginView loginId={loginId} setLoginId={setLoginId} loginPw={loginPw} setLoginPw={setLoginPw} handleLogin={handleLogin} saveId={saveId} setSaveId={setSaveId} loading={loading} /></div>
                    ) : (
                        <>
                            <Sidebar user={user} view={view} setView={(v) => { if(v==='write') setEditTbmData(null); setView(v); }} handleLogout={handleLogout} />
                            <main className="flex-1 ml-64 p-8 overflow-y-auto h-screen bg-gray-50">
                                {view === 'dashboard' && <DashboardView stats={stats} tbms={tbms} currentYear={currentYear} setCurrentYear={setCurrentYear} allTbms={tbms} availableYears={availableYears} />}
                                {view === 'list' && (
                                    <ListView 
                                        user={user} 
                                        myTbms={myTbms} 
                                        setView={(v) => { if(v==='write') setEditTbmData(null); setView(v); }} 
                                        accounts={accounts} 
                                        allTbms={tbms} 
                                        currentYear={currentYear} 
                                        setCurrentYear={setCurrentYear} 
                                        onEdit={handleEditTbm} 
                                        onDelete={handleDeleteTbm} 
                                        onPdfDownload={handlePdfDownload}
                                        availableYears={availableYears}
                                    />
                                )}
                                {view === 'write' && <TBMFormView user={user} setView={setView} showToast={showToast} setLoading={setLoading} initialData={editTbmData} />}
                                {view === 'admin' && <AdminView accounts={accounts} showToast={showToast} />}
                                {view === 'settings' && <SettingsView availableYears={availableYears} setAvailableYears={setAvailableYears} />}
                            </main>
                        </>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ErrorBoundary><App /></ErrorBoundary>);
        
        // Dynamic Style for animation
        const styleSheet = document.createElement("style");
        styleSheet.innerText = `
            .input-field { width: 100%; border: 1px solid #d1d5db; border-radius: 0.375rem; padding: 0.5rem 0.75rem; outline: none; transition: border-color 0.2s; }
            .input-field:focus { border-color: #4f46e5; box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2); }
            .label-text { display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.25rem; }
            @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
            .animate-fade-in-up { animation: fadeInUp 0.5s ease-out forwards; }
            @keyframes bounceIn { 0% { transform: scale(0.9); opacity: 0; } 70% { transform: scale(1.05); } 100% { transform: scale(1); opacity: 1; } }
            .animate-bounce-in { animation: bounceIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        `;
        document.head.appendChild(styleSheet);
    </script>
</body>
</html>
