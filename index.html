<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart TBM : Enterprise Safety Management</title>
    
    <!-- React & ReactDOM (Core) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (Transpiler) -->
    <script src="https://unpkg.com/@babel/standalone@7.23.5/babel.min.js"></script>
    
    <!-- Tailwind CSS (Styling) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- PDF Generation Libs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- FontAwesome & Google Fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Pen+Script&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, where, updateDoc, setDoc, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        
        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyBYC9PUBg62xJi7L_C692VX6RwziN8B-GU",
            authDomain: "dol-party.firebaseapp.com",
            projectId: "dol-party",
            storageBucket: "dol-party.firebasestorage.app",
            messagingSenderId: "489405410374",
            appId: "1:489405410374:web:9985f13204301ad3fcee47",
            measurementId: "G-YKZ3LC9YL8"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Expose to window for React to use
        window.db = db;
        window.auth = auth;
        window.firebaseModules = { collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, where, updateDoc, setDoc, getDocs, getDoc, signInAnonymously };
    </script>

    <style>
        :root {
            --g-bg: #f5f8fd;
            --g-panel: #ffffff;
            --g-text: #1f2937;
            --g-subtext: #64748b;
            --g-line: #dbe4f0;
            --g-primary: #1a73e8;
            --g-primary-soft: #e8f0fe;
        }
        body {
            font-family: 'Noto Sans KR', sans-serif;
            color: var(--g-text);
            background:
                radial-gradient(900px 400px at -10% -10%, #dbeafe 0%, transparent 60%),
                radial-gradient(900px 400px at 110% -10%, #e0f2fe 0%, transparent 60%),
                var(--g-bg);
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .signature-font { font-family: 'Nanum Pen Script', cursive; font-size: 1.5rem; color: #1a73e8; }
        .pdf-doc table th,
        .pdf-doc table td {
            vertical-align: middle !important;
        }
        .pdf-doc .pdf-header-cell {
            position: relative;
            padding-top: 4px !important;
            padding-bottom: 8px !important;
        }
        .pdf-doc .pdf-header-text {
            display: inline-block;
            position: relative;
            top: -2px;
            line-height: 1.2;
        }
        .pdf-doc .pdf-body-text {
            display: inline-block;
            position: relative;
            top: -1px;
            line-height: 1.25;
        }
        
        /* Print/PDF specific styles */
        .print-only { display: none; }
        
        /* Canvas specific */
        canvas { touch-action: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        const { collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, where, updateDoc, setDoc, getDocs, getDoc, signInAnonymously } = window.firebaseModules;
        const db = window.db;
        const auth = window.auth;
        const { jsPDF } = window.jspdf;

        // --- Utils (ISO 8601 Standard) ---
        const getWeekNumber = (d) => {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            const weekNo = Math.ceil(( ( (d - yearStart) / 86400000) + 1)/7);
            return weekNo;
        };

        const getFormattedWeek = (dateStr) => {
            const d = new Date(dateStr);
            const year = d.getFullYear();
            const month = d.getMonth() + 1;
            const firstDayOfMonth = new Date(year, month - 1, 1);
            const firstDayOfWeek = firstDayOfMonth.getDay();
            const offsetDate = d.getDate() + firstDayOfWeek - 1;
            const weekOfMonth = Math.floor(offsetDate / 7) + 1;
            return `${year}ë…„ ${month}ì›” ${weekOfMonth}ì£¼ì°¨`;
        };

        const getLocalDateInputValue = () => {
            const now = new Date();
            const offsetMs = now.getTimezoneOffset() * 60000;
            return new Date(now.getTime() - offsetMs).toISOString().split('T')[0];
        };

        const hashPassword = async (plainText) => {
            const msgUint8 = new TextEncoder().encode(String(plainText || ''));
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);
            return Array.from(new Uint8Array(hashBuffer))
                .map((b) => b.toString(16).padStart(2, '0'))
                .join('');
        };

        const verifyPassword = async (inputPassword, account) => {
            const normalizedInput = String(inputPassword ?? '').trim();
            if (account?.passwordHash) {
                const hashed = await hashPassword(normalizedInput);
                return hashed === account.passwordHash;
            }
            // Legacy fallback for old documents (plain password)
            const legacyCandidates = [
                account?.password,
                account?.pw,
                account?.pass
            ];
            return legacyCandidates.some((v) => {
                if (v === undefined || v === null) return false;
                return normalizedInput === String(v).trim();
            });
        };

        // FIXED: ISO 8601 compliant week date range calculator
        const getWeekDetails = (year, weekNo) => {
            // ISO Week 1 is the week with the first Thursday of the year (Jan 4th is always in Week 1)
            const jan4 = new Date(year, 0, 4);
            const day = jan4.getDay() || 7; // Mon=1, Sun=7
            const week1Start = new Date(jan4);
            week1Start.setDate(jan4.getDate() - day + 1); // Start of ISO Week 1 (Monday)

            // Calculate start date of the requested week
            const start = new Date(week1Start);
            start.setDate(week1Start.getDate() + (weekNo - 1) * 7);
            
            const end = new Date(start);
            end.setDate(start.getDate() + 6);
            
            // Format dates
            const fmt = (date) => `${String(date.getMonth() + 1).padStart(2, '0')}.${String(date.getDate()).padStart(2, '0')}`;
            
            // Determine month for label (based on Thursday of the week to handle month overlap)
            const thursday = new Date(start);
            thursday.setDate(start.getDate() + 3);
            const month = thursday.getMonth() + 1;
            
            // Simple visual "Week of Month" for the label
            const weekOfMonth = Math.ceil(start.getDate() / 7);

            return {
                startYear: start.getFullYear(),
                label: `${year}ë…„ ${month}ì›” ${weekOfMonth}ì£¼ì°¨ (${fmt(start)}~${fmt(end)})`,
                value: `${year}-W${weekNo}`
            };
        };

        // --- Error Boundary ---
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="flex flex-col items-center justify-center h-screen bg-red-50 text-red-800 p-8">
                            <i className="fas fa-exclamation-triangle text-6xl mb-4"></i>
                            <h1 className="text-3xl font-bold mb-2">ì‹œìŠ¤í…œ ì˜¤ë¥˜ ë°œìƒ</h1>
                            <p className="mb-6 text-center max-w-md">ì¼ì‹œì ì¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.<br/>(Error: {this.state.error.message})</p>
                            <button onClick={() => window.location.reload()} className="px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition shadow-lg">ì¬ì‹œì‘</button>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // --- Helper Components ---
        const Toast = ({ message, type, onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 3000);
                return () => clearTimeout(timer);
            }, []);
            const bgClass = type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-blue-600';
            return (
                <div className={`fixed top-5 right-5 ${bgClass} text-white px-6 py-3 rounded-lg shadow-xl z-50 flex items-center animate-bounce-in z-50`}>
                    <i className={`fas ${type === 'success' ? 'fa-check-circle' : 'fa-info-circle'} mr-3`}></i>
                    {message}
                </div>
            );
        };

        // --- Chart Components ---
        const KPICard = ({ title, value, icon, color, subtext }) => {
            const iconTextClassMap = {
                'bg-blue-500': 'text-blue-600',
                'bg-green-500': 'text-green-600',
                'bg-purple-500': 'text-purple-600',
                'bg-pink-500': 'text-pink-600'
            };
            const iconTextClass = iconTextClassMap[color] || 'text-indigo-600';
            return (
                <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
                    <div className="flex justify-between items-start">
                        <div>
                            <p className="text-sm text-gray-500 mb-1 font-medium">{title}</p>
                            <h3 className="text-3xl font-bold text-gray-800">{value}</h3>
                        </div>
                        <div className={`p-3 rounded-lg ${color} bg-opacity-10 ${iconTextClass}`}>
                            <i className={`fas ${icon} text-xl`}></i>
                        </div>
                    </div>
                    <p className="text-xs text-gray-400 mt-4">{subtext}</p>
                </div>
            );
        };

        const SimpleBarChart = ({ data }) => {
            const values = data.map(d => d.value);
            const maxVal = Math.max(...values);
            const scaleMax = maxVal === 0 ? 5 : maxVal <= 5 ? maxVal + 2 : maxVal * 1.2;
            
            return (
                <div className="h-64 flex items-end justify-around space-x-2 pt-10 border-b border-gray-200">
                    {data.map((d, i) => (
                        <div key={i} className="flex flex-col items-center w-full group">
                            <div className="relative w-full flex justify-center h-full items-end">
                                <div className="absolute -top-8 bg-gray-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity z-10">
                                    {d.value}ê±´
                                </div>
                                <div 
                                    className="w-3/5 bg-indigo-500 rounded-t-md hover:bg-indigo-600 transition-all duration-500 relative"
                                    style={{ height: `${(d.value / scaleMax) * 100}%`, minHeight: d.value > 0 ? '4px' : '0' }}
                                >
                                </div>
                            </div>
                            <span className="text-xs text-gray-500 mt-2 font-medium">{d.label}</span>
                        </div>
                    ))}
                </div>
            );
        };

        const DonutChart = ({ data }) => {
            const total = data.reduce((acc,cur) => acc + cur.value, 0); 
            const renderTotal = total || 1; // Prevent division by zero only for scale calculation
            const colors = ['#6366f1', '#ec4899', '#10b981', '#f59e0b'];
            
            return (
                <div className="flex flex-col items-center justify-center pt-2">
                    <div className="relative w-40 h-40 rounded-full border-8 border-gray-100 flex items-center justify-center">
                        {/* Only show color if there is actual data */}
                        {total > 0 && (
                            <div className="absolute inset-0 rounded-full opacity-20 bg-[conic-gradient(at_center,_var(--tw-gradient-stops))] from-indigo-500 via-purple-500 to-pink-500"></div>
                        )}
                        <div className="text-center">
                            <div className="text-2xl font-bold text-gray-800">{total}</div>
                            <div className="text-xs text-gray-500">Total</div>
                        </div>
                    </div>
                    <div className="mt-6 w-full space-y-2">
                        {total === 0 ? (
                            <div className="text-center text-sm text-gray-400 py-4">ë“±ë¡ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
                        ) : (
                            data.slice(0,4).map((d, i) => (
                                <div key={i} className="flex justify-between text-sm px-4">
                                    <span className="flex items-center"><span className="w-3 h-3 rounded-full mr-2" style={{backgroundColor: colors[i%4]}}></span>{d.label}</span>
                                    <span className="font-bold">{Math.round((d.value/renderTotal)*100)}%</span>
                                </div>
                            ))
                        )}
                    </div>
                </div>
            );
        };

        const RiskGauge = ({ score }) => {
            const rotation = (score / 100) * 180;
            const color = score > 80 ? '#22c55e' : score > 50 ? '#eab308' : '#ef4444';
            return (
                <div className="relative w-48 h-24 overflow-hidden mx-auto mt-4">
                    <div className="absolute top-0 left-0 w-full h-full bg-gray-200 rounded-t-full"></div>
                    <div className="absolute top-0 left-0 w-full h-full rounded-t-full origin-bottom transform transition-transform duration-1000 ease-out" style={{ background: color, transform: `rotate(${rotation - 180}deg)` }}></div>
                    <div className="absolute bottom-0 left-1/2 transform -translate-x-1/2 translate-y-1/2 w-32 h-32 bg-white rounded-full flex items-center justify-center border-4 border-gray-100">
                        <span className="text-2xl font-bold -mt-8 text-gray-700">{score}ì </span>
                    </div>
                </div>
            );
        };

        // --- Signature Pad Component ---
        const SignatureModal = ({ isOpen, onClose, onSave, signerName }) => {
            const canvasRef = useRef(null);
            const isDrawing = useRef(false);
            const [hasSigned, setHasSigned] = useState(false);

            useEffect(() => {
                if (isOpen && canvasRef.current) {
                    const canvas = canvasRef.current;
                    const ctx = canvas.getContext('2d');
                    ctx.lineWidth = 3;
                    ctx.lineCap = 'round';
                    ctx.strokeStyle = 'black';
                    
                    setTimeout(() => {
                        const rect = canvas.getBoundingClientRect();
                        canvas.width = rect.width;
                        canvas.height = rect.height;
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                    }, 50);
                    
                    setHasSigned(false);
                }
            }, [isOpen]);

            const getPos = (e) => {
                const canvas = canvasRef.current;
                const rect = canvas.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;

                return {
                    x: (clientX - rect.left) * scaleX,
                    y: (clientY - rect.top) * scaleY
                };
            };

            const startDrawing = (e) => {
                isDrawing.current = true;
                const { x, y } = getPos(e);
                const ctx = canvasRef.current.getContext('2d');
                ctx.beginPath();
                ctx.moveTo(x, y);
            };

            const draw = (e) => {
                if (!isDrawing.current) return;
                e.preventDefault();
                const { x, y } = getPos(e);
                const ctx = canvasRef.current.getContext('2d');
                ctx.lineTo(x, y);
                ctx.stroke();
                setHasSigned(true);
            };

            const stopDrawing = () => {
                isDrawing.current = false;
            };

            const handleSave = () => {
                if (!hasSigned) return;
                const dataUrl = canvasRef.current.toDataURL();
                onSave(dataUrl);
                onClose();
            };

            const handleClear = () => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                setHasSigned(false);
            };

            if (!isOpen) return null;

            const modalUi = (
                <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg flex flex-col">
                        <div className="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-xl">
                            <h3 className="font-bold text-lg text-gray-800"><i className="fas fa-pen-nib mr-2 text-indigo-600"></i>ì „ì ì„œëª… ({signerName})</h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600"><i className="fas fa-times text-xl"></i></button>
                        </div>
                        <div className="p-4 bg-gray-100 flex-1 relative h-64">
                            <canvas
                                ref={canvasRef}
                                style={{width: '100%', height: '100%'}}
                                className="bg-white rounded border border-gray-300 shadow-inner block cursor-crosshair"
                                onMouseDown={startDrawing}
                                onMouseMove={draw}
                                onMouseUp={stopDrawing}
                                onMouseLeave={stopDrawing}
                                onTouchStart={startDrawing}
                                onTouchMove={draw}
                                onTouchEnd={stopDrawing}
                            />
                            {!hasSigned && <div className="absolute inset-0 flex items-center justify-center pointer-events-none opacity-30 text-2xl font-bold text-gray-400">ì„œëª…í•´ ì£¼ì„¸ìš”</div>}
                        </div>
                        <div className="p-4 border-t flex justify-between gap-3">
                            <button onClick={handleClear} className="px-4 py-2 border border-gray-300 text-gray-600 rounded hover:bg-gray-50"><i className="fas fa-eraser mr-1"></i> ì§€ìš°ê¸°</button>
                            <div className="flex gap-2">
                                <button onClick={onClose} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">ì·¨ì†Œ</button>
                                <button onClick={handleSave} disabled={!hasSigned} className={`px-6 py-2 text-white rounded font-bold shadow ${!hasSigned ? 'bg-gray-400 cursor-not-allowed' : 'bg-indigo-600 hover:bg-indigo-700'}`}>ì„œëª… ì™„ë£Œ</button>
                            </div>
                        </div>
                    </div>
                </div>
            );

            return ReactDOM.createPortal(modalUi, document.body);
        };

        // --- Hidden PDF Generator (Auto Download - Fixed Layout) ---
        const PdfHiddenGenerator = ({ tbm, onComplete }) => {
            const printRef = useRef(null);
            
            useEffect(() => {
                const generate = async () => {
                    if(!printRef.current) return;
                    try {
                        if (document.fonts && document.fonts.ready) {
                            await document.fonts.ready;
                        }
                        await new Promise(resolve => setTimeout(resolve, 500));
                        const canvas = await html2canvas(printRef.current, {
                            scale: 2,
                            useCORS: true,
                            backgroundColor: '#ffffff',
                            width: printRef.current.scrollWidth,
                            height: printRef.current.scrollHeight,
                            windowWidth: printRef.current.scrollWidth,
                            windowHeight: printRef.current.scrollHeight
                        });
                        const imgData = canvas.toDataURL('image/png');
                        const pdf = new jsPDF('p', 'mm', 'a4');
                        const pageWidth = pdf.internal.pageSize.getWidth();
                        const pageHeight = pdf.internal.pageSize.getHeight();
                        const imgWidth = pageWidth;
                        const imgHeight = (canvas.height * imgWidth) / canvas.width;

                        let heightLeft = imgHeight;
                        let position = 0;

                        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;

                        while (heightLeft > 0) {
                            position = heightLeft - imgHeight;
                            pdf.addPage();
                            pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                            heightLeft -= pageHeight;
                        }
                        pdf.save(`TBM_${tbm.date}_${tbm.department}.pdf`);
                    } catch (e) {
                        console.error("PDF Gen Error", e);
                    } finally {
                        onComplete();
                    }
                };
                generate();
            }, []);

            return (
                <div style={{ position: 'fixed', left: '-10000px', top: 0 }}>
                    <div
                        ref={printRef}
                        className="pdf-doc bg-white p-8 text-black w-[210mm] min-h-[297mm] text-sm leading-relaxed border border-gray-300 font-sans"
                        style={{ boxSizing: 'border-box' }}
                    >
                        <h1 className="text-3xl font-bold text-center mb-8 pb-4 border-b-2 border-black">Tool Box Meeting íšŒì˜ë¡</h1>
                        
                        <table className="w-full border-collapse border-2 border-black mb-6 table-fixed">
                            <tbody>
                                <tr className="h-10">
                                    <th className="border border-black bg-gray-100 w-[15%] text-center align-middle font-bold" style={{verticalAlign: 'middle'}}>TBM ì¼ì‹œ</th>
                                    <td className="border border-black pl-2 align-middle" style={{verticalAlign: 'middle'}}>{tbm.date} {tbm.startTime} ~ {tbm.endTime}</td>
                                    <th className="border border-black bg-gray-100 w-[15%] text-center align-middle font-bold" style={{verticalAlign: 'middle'}}>ì‘ì„±ì</th>
                                    <td className="border border-black pl-2 align-middle" style={{verticalAlign: 'middle'}}>{tbm.leader} ({tbm.department})</td>
                                </tr>
                                <tr className="h-10">
                                    <th className="border border-black bg-gray-100 text-center align-middle font-bold" style={{verticalAlign: 'middle'}}>ì‘ì—…ëª…</th>
                                    <td colSpan="3" className="border border-black pl-2 align-middle font-bold" style={{verticalAlign: 'middle'}}>{tbm.workName}</td>
                                </tr>
                                <tr className="h-10">
                                    <th className="border border-black bg-gray-100 text-center align-middle font-bold" style={{verticalAlign: 'middle'}}>ì‘ì—…ì¥ì†Œ</th>
                                    <td className="border border-black pl-2 align-middle" style={{verticalAlign: 'middle'}}>{tbm.location}</td>
                                    <th className="pdf-header-cell border border-black bg-gray-100 text-center align-middle font-bold text-xs" style={{verticalAlign: 'middle'}}><span className="pdf-header-text">ìœ„í—˜ì„±í‰ê°€<br/>ì‹¤ì‹œì—¬ë¶€</span></th>
                                    <td className="border border-black pl-2 align-middle text-center" style={{verticalAlign: 'middle'}}>{tbm.riskAssessmentDone ? 'â˜‘ ì˜ˆ' : 'â˜ ì•„ë‹ˆì˜¤'}</td>
                                </tr>
                                <tr className="h-10">
                                    <th className="border border-black bg-gray-100 text-center align-middle font-bold" style={{verticalAlign: 'middle'}}>í˜„ì¥ í™˜ê²½</th>
                                    <td colSpan="3" className="border border-black pl-2 align-middle" style={{verticalAlign: 'middle'}}>
                                        <span className="mr-6"><strong>ì˜¨ë„:</strong> {tbm.temperature || '-'}â„ƒ</span>
                                        <span><strong>ìŠµë„:</strong> {tbm.humidity || '-'}%</span>
                                    </td>
                                </tr>
                                <tr>
                                    <th className="border border-black bg-gray-100 text-center align-middle font-bold" style={{verticalAlign: 'middle'}}>ì‘ì—…ë‚´ìš©</th>
                                    <td colSpan="3" className="border border-black p-2 h-24 align-top whitespace-pre-wrap leading-normal" style={{verticalAlign: 'top'}}>{tbm.workDesc}</td>
                                </tr>
                            </tbody>
                        </table>

                        <div className="mb-6">
                            <h4 className="font-bold mb-2 border-l-4 border-black pl-2">1. ìœ„í—˜ìš”ì¸ ë° ëŒ€ì±…</h4>
                            <table className="w-full border-collapse border border-black text-sm table-fixed" style={{ width: '100%', tableLayout: 'fixed', borderCollapse: 'collapse', borderSpacing: 0 }}>
                                <thead>
                                    <tr className="bg-gray-100">
                                        <th className="pdf-header-cell border border-black text-center align-middle" style={{width: '10%', verticalAlign: 'middle', padding: '6px 4px', lineHeight: 1.3}}><span className="pdf-header-text">No</span></th>
                                        <th className="pdf-header-cell border border-black text-center align-middle" style={{width: '45%', verticalAlign: 'middle', padding: '6px 4px', lineHeight: 1.3}}><span className="pdf-header-text">ì ì¬ìœ„í—˜ìš”ì¸</span></th>
                                        <th className="pdf-header-cell border border-black text-center align-middle" style={{width: '45%', verticalAlign: 'middle', padding: '6px 4px', lineHeight: 1.3}}><span className="pdf-header-text">ì•ˆì „ëŒ€ì±…</span></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {tbm.risks && tbm.risks.map((r, i) => (
                                        <tr key={i}>
                                            <td className="border border-black text-center align-middle" style={{verticalAlign: 'middle', padding: '6px 4px', lineHeight: 1.35}}>{i+1}</td>
                                            <td className="border border-black whitespace-pre-wrap" style={{verticalAlign: 'middle', padding: '6px 8px', lineHeight: 1.35, overflowWrap: 'anywhere'}}><span className="pdf-body-text">{r.factor}</span></td>
                                            <td className="border border-black whitespace-pre-wrap" style={{verticalAlign: 'middle', padding: '6px 8px', lineHeight: 1.35, overflowWrap: 'anywhere'}}><span className="pdf-body-text">{r.measure}</span></td>
                                        </tr>
                                    ))}
                                    {(!tbm.risks || tbm.risks.length === 0) && <tr><td colSpan="3" className="border border-black text-center" style={{padding: '10px 8px', lineHeight: 1.35}}>ê¸°ë¡ ì—†ìŒ</td></tr>}
                                </tbody>
                            </table>
                        </div>

                        <div className="mb-6">
                            <table className="w-full border-collapse border-2 border-black table-fixed">
                                <tbody>
                                    <tr>
                                        <th className="border border-black bg-gray-100 w-[15%] text-center align-middle font-bold" rowSpan="2" style={{verticalAlign: 'middle'}}>ì¤‘ì ìœ„í—˜<br/>ìš”ì¸</th>
                                        <th className="border border-black w-[15%] text-center align-middle bg-gray-50" style={{verticalAlign: 'middle'}}>ì„ ì •</th>
                                        <td className="border border-black p-2 align-middle font-bold whitespace-pre-wrap" style={{verticalAlign: 'middle'}}>{tbm.keyRiskFactor || '-'}</td>
                                    </tr>
                                    <tr>
                                        <th className="border border-black w-[15%] text-center align-middle bg-gray-50" style={{verticalAlign: 'middle'}}>ëŒ€ì±…</th>
                                        <td className="border border-black p-2 align-middle text-blue-700 whitespace-pre-wrap" style={{verticalAlign: 'middle'}}>{tbm.keyRiskMeasure || '-'}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div className="mb-6">
                            <h4 className="font-bold mb-2 border-l-4 border-black pl-2">2. ì‘ì—… ì „ ì•ˆì „ì¡°ì¹˜ í™•ì¸</h4>
                            <table className="w-full border-collapse border border-black text-sm table-fixed" style={{ width: '100%', tableLayout: 'fixed', borderCollapse: 'collapse', borderSpacing: 0 }}>
                                <thead>
                                    <tr className="bg-gray-100">
                                        <th className="pdf-header-cell border border-black text-center align-middle" style={{width: '50%', verticalAlign: 'middle', padding: '6px 4px', lineHeight: 1.3}}><span className="pdf-header-text">ì ì¬ìœ„í—˜ìš”ì†Œ(ì¤‘ì ìœ„í—˜ í¬í•¨)</span></th>
                                        <th className="pdf-header-cell border border-black text-center align-middle" style={{width: '20%', verticalAlign: 'middle', padding: '6px 4px', lineHeight: 1.3}}><span className="pdf-header-text">ì¡°ì¹˜ì—¬ë¶€</span></th>
                                        <th className="pdf-header-cell border border-black text-center align-middle" style={{width: '30%', verticalAlign: 'middle', padding: '6px 4px', lineHeight: 1.3}}><span className="pdf-header-text">'ì•„ë‹ˆì˜¤'ì¸ ê²½ìš° ì¡°ì¹˜ë‚´ìš©</span></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {((tbm.safetyActionChecks && tbm.safetyActionChecks.length > 0)
                                        ? tbm.safetyActionChecks
                                        : (tbm.risks || []).filter(r => (r.factor || '').trim() !== '').map(r => ({
                                            risk: r.factor,
                                            result: r.result || 'yes',
                                            action: r.action || ''
                                        }))
                                    ).length > 0 ? (
                                        ((tbm.safetyActionChecks && tbm.safetyActionChecks.length > 0)
                                            ? tbm.safetyActionChecks
                                            : (tbm.risks || []).filter(r => (r.factor || '').trim() !== '').map(r => ({
                                                risk: r.factor,
                                                result: r.result || 'yes',
                                                action: r.action || ''
                                            }))
                                        ).map((check, i) => (
                                            <tr key={i}>
                                                <td className="border border-black whitespace-pre-wrap" style={{verticalAlign: 'middle', padding: '6px 8px', lineHeight: 1.35, overflowWrap: 'anywhere'}}><span className="pdf-body-text">{check.risk}</span></td>
                                                <td className="border border-black text-center align-middle" style={{verticalAlign: 'middle', padding: '6px 4px', lineHeight: 1.35}}>
                                                    <span className="pdf-body-text">{check.result === 'yes' ? 'â˜‘ ì˜ˆ' : 'â˜ ì•„ë‹ˆì˜¤'}</span>
                                                </td>
                                                <td className="border border-black whitespace-pre-wrap" style={{verticalAlign: 'middle', padding: '6px 8px', lineHeight: 1.35, overflowWrap: 'anywhere'}}>{check.action || '-'}</td>
                                            </tr>
                                        ))
                                    ) : (
                                        <tr><td colSpan="3" className="border border-black text-center text-gray-400" style={{padding: '8px 6px', lineHeight: 1.35}}>- ë³„ë„ ê¸°ë¡ ì—†ìŒ -</td></tr>
                                    )}
                                </tbody>
                            </table>
                        </div>

                        <div className="mb-6">
                            <h4 className="font-bold mb-2 border-l-4 border-black pl-2">3. ì‘ì—… ì „ ì¼ì¼ ì•ˆì „ì ê²€ ì‹œí–‰ ê²°ê³¼</h4>
                            <div className="border border-black p-2 min-h-[50px] whitespace-pre-wrap">
                                {tbm.dailyCheckResult || 'íŠ¹ì´ì‚¬í•­ ì—†ìŒ'}
                            </div>
                        </div>

                        {tbm.photoUrl && (
                            <div className="mb-6">
                                <h4 className="font-bold mb-2 border-l-4 border-black pl-2">4. TBM í™œë™ ì‚¬ì§„</h4>
                                <div className="border border-black p-2 flex justify-center">
                                    <img src={tbm.photoUrl} alt="í™œë™ì‚¬ì§„" className="max-h-60 object-contain" />
                                </div>
                            </div>
                        )}

                        <div className="break-inside-avoid">
                            <h4 className="font-bold mb-2 border-l-4 border-black pl-2">5. ì°¸ì„ì ëª…ë‹¨ (ì´ {tbm.attendees?.length || 0}ëª…)</h4>
                            <table className="w-full border-collapse border-2 border-black table-fixed text-sm" style={{ width: '100%', tableLayout: 'fixed', borderCollapse: 'collapse', borderSpacing: 0 }}>
                                <thead>
                                    <tr className="bg-gray-100">
                                        <th className="pdf-header-cell border border-black text-center" style={{width: '25%', padding: '6px 4px', lineHeight: 1.3}}><span className="pdf-header-text">ì´ë¦„</span></th>
                                        <th className="pdf-header-cell border border-black text-center" style={{width: '25%', padding: '6px 4px', lineHeight: 1.3}}><span className="pdf-header-text">ì„œëª…</span></th>
                                        <th className="pdf-header-cell border border-black text-center" style={{width: '25%', padding: '6px 4px', lineHeight: 1.3}}><span className="pdf-header-text">ì´ë¦„</span></th>
                                        <th className="pdf-header-cell border border-black text-center" style={{width: '25%', padding: '6px 4px', lineHeight: 1.3}}><span className="pdf-header-text">ì„œëª…</span></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {(() => {
                                        const attendees = tbm.attendees || [];
                                        if (attendees.length === 0) {
                                            return (
                                                <tr>
                                                    <td colSpan="4" className="border border-black text-center text-gray-400" style={{padding: '12px 8px', lineHeight: 1.35}}>
                                                        ì°¸ì„ì ê¸°ë¡ ì—†ìŒ
                                                    </td>
                                                </tr>
                                            );
                                        }
                                        const rows = [];
                                        for (let i = 0; i < attendees.length; i += 2) {
                                            const left = attendees[i];
                                            const right = attendees[i + 1];
                                            rows.push(
                                                <tr key={i}>
                                                    <td className="border border-black h-16 align-middle text-center font-bold whitespace-pre-wrap break-words" style={{padding: '6px 8px', verticalAlign: 'middle', lineHeight: 1.35}}>{left?.name || '-'}</td>
                                                    <td className="border border-black h-16 align-middle text-center" style={{padding: '4px', verticalAlign: 'middle', lineHeight: 1.35}}>
                                                        {left?.isLeader ? (
                                                            left?.signatureUrl
                                                                ? <img src={left.signatureUrl} alt="ì„œëª…" className="max-h-12 max-w-full object-contain mx-auto" />
                                                                : <span className="text-red-500 text-xs font-bold">(ë¦¬ë” ë¯¸ì„œëª…)</span>
                                                        ) : (
                                                            <span className="text-gray-500 text-xs">ì„œëª… ìƒëµ(ëŒ€í‘œì í™•ì¸)</span>
                                                        )}
                                                    </td>
                                                    <td className="border border-black h-16 align-middle text-center font-bold whitespace-pre-wrap break-words" style={{padding: '6px 8px', verticalAlign: 'middle', lineHeight: 1.35}}>{right?.name || ''}</td>
                                                    <td className="border border-black h-16 align-middle text-center" style={{padding: '4px', verticalAlign: 'middle', lineHeight: 1.35}}>
                                                        {right ? (
                                                            right?.isLeader
                                                                ? (right?.signatureUrl
                                                                    ? <img src={right.signatureUrl} alt="ì„œëª…" className="max-h-12 max-w-full object-contain mx-auto" />
                                                                    : <span className="text-red-500 text-xs font-bold">(ë¦¬ë” ë¯¸ì„œëª…)</span>)
                                                                : <span className="text-gray-500 text-xs">ì„œëª… ìƒëµ(ëŒ€í‘œì í™•ì¸)</span>
                                                        ) : ''}
                                                    </td>
                                                </tr>
                                            );
                                        }
                                        return rows;
                                    })()}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Weekly Status Panel (Updated Logic: Sort Alphabetically) ---
        const WeeklyStatusPanel = ({ accounts, tbms, currentYear }) => {
            const [selectedWeek, setSelectedWeek] = useState(`${currentYear}-W${getWeekNumber(new Date())}`);
            
            useEffect(() => {
                setSelectedWeek(`${currentYear}-W${getWeekNumber(new Date())}`);
            }, [currentYear]);

            const weekOptions = useMemo(() => {
                const weeks = [];
                for(let i=1; i<=53; i++) {
                    const details = getWeekDetails(parseInt(currentYear), i);
                    if (details.startYear > parseInt(currentYear)) continue;
                    weeks.push(details);
                }
                return weeks;
            }, [currentYear]);

            const statusData = useMemo(() => {
                // Filter masters and Sort alphabetically (Ga-Na-Da)
                const deptList = accounts
                    .filter(a => a.role !== 'master')
                    .map(a => a.department)
                    .sort((a, b) => a.localeCompare(b, 'ko')); // Added sorting here for explicit order
                
                const selectedWeekNum = parseInt(selectedWeek.split('-W')[1]);
                
                const result = deptList.map(dept => {
                    const submitted = tbms.find(t => {
                        if (t.department !== dept) return false;
                        if (!t.date.startsWith(currentYear)) return false;
                        return getWeekNumber(new Date(t.date)) === selectedWeekNum;
                    });
                    return { department: dept, submitted: !!submitted, data: submitted };
                });
                return result;
            }, [accounts, tbms, selectedWeek, currentYear]);

            return (
                <div className="bg-indigo-50 border border-indigo-100 rounded-lg p-4 mb-6">
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-2">
                        <h3 className="font-bold text-indigo-800"><i className="fas fa-calendar-check mr-2"></i>ì£¼ê°„ ë¶€ì„œë³„ ì œì¶œ í˜„í™©</h3>
                        <select className="border border-indigo-200 rounded px-3 py-1 text-sm bg-white w-full sm:w-auto font-bold text-gray-700" value={selectedWeek} onChange={e=>setSelectedWeek(e.target.value)}>
                            {weekOptions.map(w => <option key={w.value} value={w.value}>{w.label}</option>)}
                        </select>
                    </div>
                    <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3">
                        {statusData.map(s => (
                            <div key={s.department} className={`p-3 rounded border text-center transition flex flex-col items-center justify-center ${s.submitted ? 'bg-white border-green-200 shadow-sm' : 'bg-gray-50 border-red-200 opacity-80'}`}>
                                <div className="text-xs text-gray-500 mb-1">{s.department}</div>
                                {s.submitted ? (
                                    <div className="text-green-600 font-bold text-sm"><i className="fas fa-check-circle mr-1"></i>ì œì¶œì™„ë£Œ</div>
                                ) : (
                                    <div className="text-red-400 font-bold text-sm"><i className="fas fa-times-circle mr-1"></i>ë¯¸ì œì¶œ</div>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // --- Settings View (Master Only) ---
        const SettingsView = ({ availableYears, setAvailableYears }) => {
            const [newYear, setNewYear] = useState('');

            const handleAddYear = async () => {
                if (!newYear || availableYears.includes(newYear)) return;
                const updated = [...availableYears, newYear].sort();
                setAvailableYears(updated);
                await setDoc(doc(db, "system_settings", "config"), { years: updated });
                setNewYear('');
            };

            const handleRemoveYear = async (year) => {
                if (availableYears.length <= 1) return alert("ìµœì†Œ 1ê°œì˜ ì—°ë„ëŠ” í•„ìš”í•©ë‹ˆë‹¤.");
                const updated = availableYears.filter(y => y !== year);
                setAvailableYears(updated);
                await setDoc(doc(db, "system_settings", "config"), { years: updated });
            };

            return (
                <div className="bg-white p-8 rounded-xl shadow animate-fade-in-up">
                    <h2 className="text-2xl font-bold text-gray-800 mb-6 border-b pb-2"><i className="fas fa-cog mr-2"></i>ì‹œìŠ¤í…œ ì„¤ì •</h2>
                    <div className="mb-8">
                        <h3 className="font-bold text-lg mb-4 text-gray-700">ğŸ“… ì¡°íšŒ ì—°ë„ ê´€ë¦¬</h3>
                        <div className="flex gap-2 mb-4">
                            <input type="number" className="border rounded px-4 py-2 w-48" placeholder="ì˜ˆ: 2027" value={newYear} onChange={e => setNewYear(e.target.value)} />
                            <button onClick={handleAddYear} className="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">ì¶”ê°€</button>
                        </div>
                        <div className="flex flex-wrap gap-2">
                            {availableYears.map(year => (
                                <div key={year} className="bg-gray-100 px-4 py-2 rounded-full flex items-center gap-2 border">
                                    <span className="font-bold">{year}ë…„</span>
                                    <button onClick={() => handleRemoveYear(year)} className="text-red-400 hover:text-red-600"><i className="fas fa-times-circle"></i></button>
                                </div>
                            ))}
                        </div>
                        <p className="text-sm text-gray-400 mt-2">* ì´ê³³ì—ì„œ ì„¤ì •í•œ ì—°ë„ë§Œ ëŒ€ì‹œë³´ë“œì™€ ì´ë ¥ ì¡°íšŒ í•„í„°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                    </div>
                </div>
            );
        };

        // --- View Components ---
        const LoginView = ({ loginId, setLoginId, loginPw, setLoginPw, handleLogin, saveId, setSaveId, loading }) => (
            <div className="min-h-screen flex items-center justify-center bg-transparent px-4">
                <div className="bg-white/95 p-8 rounded-3xl shadow-[0_16px_48px_rgba(15,23,42,0.12)] w-full max-w-md border border-blue-100">
                    <div className="text-center mb-8">
                        <div className="w-16 h-16 bg-blue-50 text-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-4 text-2xl"><i className="fas fa-shield-alt"></i></div>
                        <h2 className="text-2xl font-bold text-gray-800">Smart TBM System</h2>
                        <p className="text-gray-500 mt-2 text-sm">ì•ˆì „í•œ ì‘ì—…ì„ ìœ„í•œ ì²«ê±¸ìŒ</p>
                    </div>
                    <form onSubmit={handleLogin} className="space-y-6">
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">ì•„ì´ë”” (ë¶€ì„œì½”ë“œ)</label>
                            <input type="text" className="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-indigo-500 transition outline-none" placeholder="admin or dept_id" value={loginId} onChange={e => setLoginId(e.target.value)} required />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">ë¹„ë°€ë²ˆí˜¸</label>
                            <input type="password" className="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-indigo-500 transition outline-none" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" value={loginPw} onChange={e => setLoginPw(e.target.value)} required />
                        </div>
                        <div className="flex items-center">
                            <input id="saveId" type="checkbox" className="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" checked={saveId} onChange={e => setSaveId(e.target.checked)} />
                            <label htmlFor="saveId" className="ml-2 block text-sm text-gray-900">ì•„ì´ë”” ì €ì¥</label>
                        </div>
                        <button type="submit" className="w-full bg-blue-600 text-white py-3 rounded-xl hover:bg-blue-700 transition font-bold shadow-md transform active:scale-95">{loading ? <i className="fas fa-spinner fa-spin"></i> : 'ë¡œê·¸ì¸'}</button>
                    </form>
                </div>
            </div>
        );

        const Sidebar = ({ user, view, setView, handleLogout }) => (
            <div className="w-64 bg-white/90 backdrop-blur-xl text-slate-700 h-screen fixed left-0 top-0 flex flex-col border-r border-blue-100 shadow-[0_8px_24px_rgba(15,23,42,0.08)] z-20">
                <div className="p-6 border-b border-blue-100">
                    <h1 className="text-xl font-bold tracking-wider text-blue-700"><i className="fas fa-hard-hat mr-2"></i>Smart TBM</h1>
                    <p className="text-xs text-slate-400 mt-1">Enterprise EHS System</p>
                </div>
                <div className="p-4 border-b border-blue-100 bg-blue-50/60">
                    <div className="flex items-center space-x-3">
                        <div className="w-10 h-10 rounded-xl bg-blue-600 text-white flex items-center justify-center text-lg font-bold">{user.department.substring(0,1)}</div>
                        <div>
                            <p className="font-medium text-sm">{user.department}</p>
                            <p className="text-xs text-slate-500 capitalize">{user.role}</p>
                        </div>
                    </div>
                </div>
                <nav className="flex-1 p-4 space-y-2 mt-2">
                    <button onClick={() => setView('dashboard')} className={`w-full text-left p-3 rounded-xl flex items-center transition ${view === 'dashboard' ? 'bg-blue-600 text-white shadow-md' : 'text-slate-500 hover:bg-blue-50 hover:text-blue-700'}`}><i className="fas fa-chart-pie w-6"></i> ëŒ€ì‹œë³´ë“œ</button>
                    <button onClick={() => setView('write')} className={`w-full text-left p-3 rounded-xl flex items-center transition ${view === 'write' ? 'bg-blue-600 text-white shadow-md' : 'text-slate-500 hover:bg-blue-50 hover:text-blue-700'}`}><i className="fas fa-edit w-6"></i> TBM ë“±ë¡</button>
                    <button onClick={() => setView('list')} className={`w-full text-left p-3 rounded-xl flex items-center transition ${view === 'list' ? 'bg-blue-600 text-white shadow-md' : 'text-slate-500 hover:bg-blue-50 hover:text-blue-700'}`}><i className="fas fa-list-alt w-6"></i> TBM ì´ë ¥ì¡°íšŒ</button>
                    {user.role === 'master' && (
                        <>
                            <div className="my-4 border-t border-blue-100"></div>
                            <button onClick={() => setView('admin')} className={`w-full text-left p-3 rounded-xl flex items-center transition ${view === 'admin' ? 'bg-pink-600 text-white shadow-md' : 'text-pink-500 hover:bg-pink-50 hover:text-pink-700'}`}><i className="fas fa-users-cog w-6"></i> ê³„ì •/ê¶Œí•œ ê´€ë¦¬</button>
                            <button onClick={() => setView('settings')} className={`w-full text-left p-3 rounded-xl flex items-center transition ${view === 'settings' ? 'bg-slate-600 text-white shadow-md' : 'text-slate-500 hover:bg-slate-100 hover:text-slate-700'}`}><i className="fas fa-cog w-6"></i> ì‹œìŠ¤í…œ ì„¤ì •</button>
                        </>
                    )}
                </nav>
                <div className="p-4 border-t border-blue-100">
                    <button onClick={handleLogout} className="w-full py-2 px-4 border border-slate-300 rounded-xl text-slate-600 hover:bg-slate-100 transition flex items-center justify-center text-sm"><i className="fas fa-sign-out-alt mr-2"></i> ë¡œê·¸ì•„ì›ƒ</button>
                </div>
            </div>
        );

        const DashboardView = ({ stats, tbms, currentYear, setCurrentYear, allTbms, availableYears }) => {
            const riskCategoryData = useMemo(() => {
                const risks = {};
                tbms.forEach(tbm => tbm.risks?.forEach(r => {
                    const key = (r.factor || "ê¸°íƒ€").split(' ')[0] || "ê¸°íƒ€";
                    risks[key] = (risks[key] || 0) + 1;
                }));
                return Object.entries(risks).map(([label, value]) => ({label, value}));
            }, [tbms]);

            // NOTE: deptRankingData Removed as per request

            // New: Calculate Safety Score based on Risk Assessment Rate
            const safetyScore = useMemo(() => {
                if (stats.total === 0) return 0;
                return Math.round((stats.safeCount / stats.total) * 100);
            }, [stats]);

            const getScoreMessage = (score) => {
                if (stats.total === 0) return "ë°ì´í„°ê°€ ìˆ˜ì§‘ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
                if (score >= 90) return "í›Œë¥­í•©ë‹ˆë‹¤! í˜„ì¬ ìµœê³  ìˆ˜ì¤€ì˜ ì•ˆì „ ê´€ë¦¬ê°€ ì´ë£¨ì–´ì§€ê³  ìˆìŠµë‹ˆë‹¤.";
                if (score >= 70) return "ì–‘í˜¸í•©ë‹ˆë‹¤. ì§€ì†ì ì¸ ìœ„í—˜ ìš”ì¸ ë°œêµ´ê³¼ ê´€ì‹¬ì´ í•„ìš”í•©ë‹ˆë‹¤.";
                return "ì£¼ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤. ìœ„í—˜ì„± í‰ê°€ ì‹¤ì‹œìœ¨ì„ ë†’ì´ê³  ì•ˆì „ ì¡°ì¹˜ë¥¼ ê°•í™”í•´ì£¼ì„¸ìš”.";
            };

            return (
                <div className="space-y-6 animate-fade-in-up">
                    <div className="flex justify-between items-end">
                        <div>
                            <h2 className="text-2xl font-bold text-gray-800">EHS ê²½ì˜ ëŒ€ì‹œë³´ë“œ</h2>
                            <p className="text-gray-500">ì‹¤ì‹œê°„ ì•ˆì „ í™œë™ í˜„í™© ë¦¬í¬íŠ¸</p>
                        </div>
                        <div className="flex items-center gap-3">
                             <select className="bg-white border border-gray-300 text-gray-700 py-1 px-3 rounded-lg font-bold" value={currentYear} onChange={(e) => setCurrentYear(e.target.value)}>
                                {availableYears.map(y => <option key={y} value={y}>{y}ë…„</option>)}
                            </select>
                            <span className="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-xs font-bold">{new Date().toLocaleDateString()} ê¸°ì¤€</span>
                        </div>
                    </div>

                    {/* Row 1: KPI Cards */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <KPICard title={`${currentYear}ë…„ ì´ TBM ìˆ˜í–‰`} value={`${stats.total}íšŒ`} icon="fa-clipboard-check" color="bg-blue-500" subtext="ì „ë…„ ë™ê¸° ëŒ€ë¹„ 12% ì¦ê°€" />
                        <KPICard title="ìœ„í—˜ì„± í‰ê°€ ì‹¤ì‹œìœ¨" value={`${stats.total ? Math.round((stats.safeCount/stats.total)*100) : 0}%`} icon="fa-shield-virus" color="bg-green-500" subtext="ëª©í‘œì¹˜ 95% ë‹¬ì„± ì¤‘" />
                        <KPICard title="ì°¸ì—¬ ì‘ì—…ì ìˆ˜" value={`${tbms.reduce((acc, cur) => acc + (cur.attendees?.length || 0), 0)}ëª…`} icon="fa-users" color="bg-purple-500" subtext="ê¸ˆì¼ í˜„ì¥ íˆ¬ì… ì¸ì›" />
                    </div>

                    {/* Row 2: Monthly Activity (Full Width for 12 months) */}
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <h3 className="font-bold text-gray-700 mb-4 border-l-4 border-indigo-500 pl-3">ì›”ë³„ TBM í™œë™ ì¶”ì´ (ì—°ê°„)</h3>
                        <SimpleBarChart data={stats.monthlyData} />
                    </div>

                    {/* Row 3: Safety Index & Risk Analysis */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        {/* Safety Index (Moved from Row 2) */}
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 text-center">
                            <h3 className="font-bold text-gray-700 mb-2 border-l-4 border-green-500 pl-3 text-left">ì¢…í•© ì•ˆì „ ì§€ìˆ˜</h3>
                            <RiskGauge score={safetyScore} />
                            <div className="mt-4 p-3 bg-gray-50 rounded text-left text-sm text-gray-600">
                                <i className="fas fa-quote-left mr-2 text-gray-400"></i>
                                {getScoreMessage(safetyScore)}
                            </div>
                        </div>
                        {/* Risk Analysis (Kept here) */}
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                            <h3 className="font-bold text-gray-700 mb-4 border-l-4 border-orange-500 pl-3">ìœ„í—˜ ìš”ì¸ ìœ í˜• ë¶„ì„</h3>
                            <DonutChart data={riskCategoryData} />
                        </div>
                    </div>
                </div>
            );
        };

        const ListView = ({ user, myTbms, setView, accounts, allTbms, currentYear, setCurrentYear, onEdit, onDelete, onPdfDownload, availableYears }) => {
            const [searchKeyword, setSearchKeyword] = useState('');
            const filteredTbms = useMemo(() => {
                const q = searchKeyword.trim().toLowerCase();
                if (!q) return myTbms;
                return myTbms.filter((tbm) =>
                    String(tbm.workName || '').toLowerCase().includes(q) ||
                    String(tbm.leader || '').toLowerCase().includes(q) ||
                    String(tbm.createdBy || '').toLowerCase().includes(q)
                );
            }, [myTbms, searchKeyword]);

            return (
                <div className="bg-white rounded-xl shadow border border-gray-200 animate-fade-in-up">
                    <div className="p-6 border-b border-gray-100 flex justify-between items-center">
                        <div>
                            <h2 className="text-xl font-bold text-gray-800">TBM ì´ë ¥ ì¡°íšŒ</h2>
                            <p className="text-sm text-gray-500">{user.role === 'master' ? 'ì „ì‚¬ í†µí•© ê´€ë¦¬ ëª¨ë“œ' : `${user.department} í™œë™ ë‚´ì—­`}</p>
                        </div>
                        <div className="flex gap-2">
                            <select className="bg-gray-50 border border-gray-300 text-gray-700 py-1 px-3 rounded shadow-sm" value={currentYear} onChange={(e) => setCurrentYear(e.target.value)}>
                                {availableYears.map(y => <option key={y} value={y}>{y}ë…„</option>)}
                            </select>
                            <button onClick={() => setView('write')} className="bg-indigo-600 text-white px-4 py-2 rounded shadow hover:bg-indigo-700 text-sm"><i className="fas fa-plus mr-1"></i> ì‹ ê·œ ë“±ë¡</button>
                        </div>
                    </div>
                    
                    {/* Weekly Status Panel (Sorted by Dept Name) */}
                    {user.role === 'master' && (
                        <div className="px-6 pt-6">
                            <WeeklyStatusPanel accounts={accounts} tbms={allTbms} currentYear={currentYear} />
                        </div>
                    )}

                    <div className="px-6 pb-4">
                        <div className="flex items-center gap-2">
                            <i className="fas fa-search text-gray-400"></i>
                            <input
                                type="text"
                                className="input-field"
                                placeholder="ì‘ì—…ëª… ë˜ëŠ” ë¦¬ë”ëª… ê²€ìƒ‰"
                                value={searchKeyword}
                                onChange={(e) => setSearchKeyword(e.target.value)}
                            />
                        </div>
                    </div>

                    <div className="overflow-x-auto">
                        <table className="w-full text-left border-collapse">
                            <thead>
                                <tr className="bg-gray-50 text-gray-500 text-sm uppercase tracking-wider">
                                    <th className="p-4 font-medium">ê¸°ê°„ (ì£¼ì°¨)</th>
                                    <th className="p-4 font-medium">ë¶€ì„œ</th>
                                    <th className="p-4 font-medium">ì‘ì—…ëª…</th>
                                    <th className="p-4 font-medium">ë¦¬ë”</th>
                                    <th className="p-4 font-medium text-center">ê´€ë¦¬</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-100">
                                {filteredTbms.length === 0 ? (
                                    <tr><td colSpan="5" className="p-8 text-center text-gray-400">{currentYear}ë…„ë„ ë“±ë¡ëœ TBM ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                                ) : filteredTbms.map(tbm => (
                                    <tr key={tbm.id} className="hover:bg-gray-50 transition">
                                        <td className="p-4 text-sm text-gray-600 font-bold">{getFormattedWeek(tbm.date)}<div className="text-xs text-gray-400 font-normal">{tbm.date}</div></td>
                                        <td className="p-4 text-sm font-bold text-indigo-600">{tbm.department}</td>
                                        <td className="p-4 text-sm font-medium text-gray-800">{tbm.workName}</td>
                                        <td className="p-4 text-sm text-gray-600">{tbm.leader}</td>
                                        <td className="p-4 text-center">
                                            <div className="flex justify-center gap-2">
                                                <button onClick={() => onEdit(tbm)} className="text-indigo-500 hover:bg-indigo-50 p-2 rounded text-xs border border-indigo-200"><i className="fas fa-edit"></i> ìˆ˜ì •</button>
                                                <button onClick={() => onDelete(tbm.id)} className="text-red-500 hover:bg-red-50 p-2 rounded text-xs border border-red-200"><i className="fas fa-trash"></i> ì‚­ì œ</button>
                                                {user.role === 'master' && (
                                                    <button onClick={() => onPdfDownload(tbm)} className="text-green-600 hover:bg-green-50 p-2 rounded text-xs border border-green-200"><i className="fas fa-file-pdf"></i> PDF</button>
                                                )}
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const AdminView = ({ accounts, showToast }) => {
            const [newAcc, setNewAcc] = useState({ username: '', password: '', department: 'ìƒì‚°íŒ€', role: 'user' });
            const [editingId, setEditingId] = useState(null);
            const [newPassword, setNewPassword] = useState('');

            const handleCreateAccount = async () => {
                if(!newAcc.username || !newAcc.password) return showToast('ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'error');
                try {
                    const passwordHash = await hashPassword(newAcc.password);
                    await addDoc(collection(db, "app_users"), {
                        username: newAcc.username.trim(),
                        department: newAcc.department.trim(),
                        role: newAcc.role,
                        passwordHash,
                        updatedAt: new Date().toISOString()
                    });
                    showToast('ê³„ì •ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                    setNewAcc({ username: '', password: '', department: 'ìƒì‚°íŒ€', role: 'user' });
                } catch(e) { showToast('ìƒì„± ì‹¤íŒ¨', 'error'); }
            };
            const handleDeleteAccount = async (id) => { if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) await deleteDoc(doc(db, "app_users", id)); };
            const handleUpdatePassword = async (id) => {
                if(!newPassword) return;
                const passwordHash = await hashPassword(newPassword);
                await updateDoc(doc(db, "app_users", id), { passwordHash, updatedAt: new Date().toISOString() });
                showToast('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì™„ë£Œ', 'success');
                setEditingId(null);
            };

            // Explicit sort for rendering
            const sortedAccounts = [...accounts].sort((a, b) => (a.department || '').localeCompare(b.department || '', 'ko'));

            return (
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 animate-fade-in-up">
                    <div className="lg:col-span-1 bg-white p-6 rounded-xl shadow h-fit">
                        <h3 className="font-bold text-lg mb-4 text-gray-800">ìƒˆ ê³„ì • ìƒì„±</h3>
                        <div className="space-y-4">
                            <input type="text" className="input-field" placeholder="ì•„ì´ë””" value={newAcc.username} onChange={e=>setNewAcc({...newAcc, username: e.target.value})} />
                            <input type="password" className="input-field" placeholder="ë¹„ë°€ë²ˆí˜¸" value={newAcc.password} onChange={e=>setNewAcc({...newAcc, password: e.target.value})} />
                            <input type="text" className="input-field" placeholder="ë¶€ì„œëª…" value={newAcc.department} onChange={e=>setNewAcc({...newAcc, department: e.target.value})} />
                            <select className="input-field" value={newAcc.role} onChange={e=>setNewAcc({...newAcc, role: e.target.value})}>
                                <option value="user">User</option>
                                <option value="master">Master</option>
                            </select>
                            <button onClick={handleCreateAccount} className="w-full bg-pink-600 text-white py-2 rounded font-bold hover:bg-pink-700 transition">ê³„ì • ìƒì„±</button>
                        </div>
                    </div>
                    <div className="lg:col-span-2 bg-white p-6 rounded-xl shadow">
                        <h3 className="font-bold text-lg mb-4 text-gray-800">ë“±ë¡ëœ ê³„ì • ëª©ë¡ (ê°€ë‚˜ë‹¤ìˆœ)</h3>
                        <div className="grid gap-3">
                            {sortedAccounts.map(acc => (
                                <div key={acc.id} className="flex flex-col sm:flex-row justify-between items-center p-3 border rounded hover:bg-gray-50 gap-3">
                                    <div className="flex-1"><span className="font-bold text-gray-700">{acc.department}</span> ({acc.username})</div>
                                    <div className="flex items-center gap-2">
                                        {editingId === acc.id ? (
                                            <div className="flex gap-1">
                                                <input type="password" className="border rounded px-2 py-1 text-sm w-32" value={newPassword} onChange={e=>setNewPassword(e.target.value)} />
                                                <button onClick={()=>handleUpdatePassword(acc.id)} className="bg-green-500 text-white px-2 py-1 rounded text-xs">ì €ì¥</button>
                                                <button onClick={()=>{setEditingId(null); setNewPassword('')}} className="bg-gray-300 text-white px-2 py-1 rounded text-xs">ì·¨ì†Œ</button>
                                            </div>
                                        ) : <button onClick={()=>{setEditingId(acc.id); setNewPassword('')}} className="text-indigo-500 border border-indigo-200 px-3 py-1 rounded text-sm">ë¹„ë²ˆë³€ê²½</button>}
                                        <button onClick={() => handleDeleteAccount(acc.id)} className="text-red-500 border border-red-200 px-3 py-1 rounded text-sm">ì‚­ì œ</button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const TBMFormView = ({ user, setView, showToast, setLoading, initialData }) => {
            const [form, setForm] = useState(initialData || {
                date: getLocalDateInputValue(),
                // Updated default times
                startTime: '09:00',
                endTime: '18:00',
                temperature: '',
                humidity: '',
                workName: '',
                workDesc: '',
                location: '',
                riskAssessmentDone: false,
                risks: [{ id: 1, factor: '', measure: '', result: 'yes', action: '' }],
                keyRiskId: '',
                leader: user.username,
                preChecks: { check1: false, check2: false, check3: false },
                safetyActionChecks: [],
                // New Fields
                dailyCheckResult: 'íŠ¹ì´ì‚¬í•­ ì—†ìŒ',
                photoUrl: '',
                attendees: [{ name: user.username || '', signed: false, signatureUrl: '', isLeader: true }]
            });
            const [showSignModal, setShowSignModal] = useState(false);
            const [currentSignerIndex, setCurrentSignerIndex] = useState(null);
            const [submitting, setSubmitting] = useState(false);
            const [showCopyOptions, setShowCopyOptions] = useState(false);
            const [copyOptions, setCopyOptions] = useState({
                overview: true,
                risks: true,
                checks: true,
                attendees: false
            });
            const draftKey = `tbm_draft_${user.department}`;

            useEffect(() => {
                if (initialData) return;
                const raw = localStorage.getItem(draftKey);
                if (!raw) return;
                try {
                    const saved = JSON.parse(raw);
                    setForm(prev => ({ ...prev, ...saved }));
                    showToast("ì´ì „ì— ì‘ì„± ì¤‘ì´ë˜ ë‚´ìš©ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.", "info");
                } catch (err) {
                    console.warn("ì„ì‹œì €ì¥ ë°ì´í„° íŒŒì‹± ì‹¤íŒ¨:", err);
                }
            }, []);

            useEffect(() => {
                if (initialData) return;
                const timer = setTimeout(() => {
                    try {
                        localStorage.setItem(draftKey, JSON.stringify(form));
                    } catch (err) {
                        console.warn("ì„ì‹œì €ì¥ ì‹¤íŒ¨:", err);
                    }
                }, 1000);
                return () => clearTimeout(timer);
            }, [form, initialData]);

            const addRiskRow = () => setForm(p => ({...p, risks: [...p.risks, { id: Date.now(), factor: '', measure: '', result: 'yes', action: '' }]}));
            const updateRisk = (id, f, v) => setForm(p => ({...p, risks: p.risks.map(r => r.id===id ? {...r, [f]: v} : r)}));
            const removeRisk = (id) => setForm(p => ({...p, risks: p.risks.filter(r => r.id !== id)}));
            const addAttendee = () => setForm(p => ({...p, attendees: [...p.attendees, { name: '', signed: false, signatureUrl: '', isLeader: false }]}));
            
            // New: Remove Attendee Function
            const removeAttendee = (idx) => {
                const newAtt = form.attendees.filter((_, i) => i !== idx);
                setForm({ ...form, attendees: newAtt });
            };

            const updateAttendee = (idx, name) => {
                const newAtt = [...form.attendees];
                newAtt[idx].name = name;
                setForm({...form, attendees: newAtt});
            };
            const openSignModal = (idx) => {
                if (!form.attendees[idx].name) return showToast("ì´ë¦„ì„ ë¨¼ì € ì…ë ¥í•˜ì„¸ìš”.", "error");
                setCurrentSignerIndex(idx);
                setShowSignModal(true);
            };
            const handleSaveSignature = (dataUrl) => {
                const newAtt = [...form.attendees];
                newAtt[currentSignerIndex].signed = true;
                newAtt[currentSignerIndex].signatureUrl = dataUrl;
                setForm({ ...form, attendees: newAtt });
            };
            
            const buildSafetyActionChecksFromRisks = (risks) => {
                return (risks || [])
                    .filter(r => String(r.factor || '').trim() !== '')
                    .map(r => ({
                        risk: r.factor,
                        result: r.result || 'yes',
                        action: r.result === 'no' ? (r.action || '') : ''
                    }));
            };
            const applyQuickDefaults = () => {
                setForm((cur) => ({
                    ...cur,
                    temperature: cur.temperature || '25',
                    humidity: cur.humidity || '50',
                    dailyCheckResult: cur.dailyCheckResult || 'íŠ¹ì´ì‚¬í•­ ì—†ìŒ',
                    preChecks: { check1: true, check2: true, check3: true }
                }));
                showToast("ê¸°ë³¸ê°’ì„ ë¹ ë¥´ê²Œ ì…ë ¥í–ˆìŠµë‹ˆë‹¤.", "success");
            };
            const fillNoIssueTemplate = () => {
                setForm((cur) => ({
                    ...cur,
                    workDesc: cur.workDesc || 'ê¸ˆì¼ ì‘ì—… ì „ TBM ì‹œí–‰, íŠ¹ì´ì‚¬í•­ ì—†ìŒ.',
                    dailyCheckResult: 'íŠ¹ì´ì‚¬í•­ ì—†ìŒ'
                }));
                showToast("ë¬´íŠ¹ì´ í…œí”Œë¦¿ì„ ì ìš©í–ˆìŠµë‹ˆë‹¤.", "info");
            };
            const toggleCopyOption = (key) => {
                setCopyOptions((prev) => ({ ...prev, [key]: !prev[key] }));
            };
            const normalizeAttendees = (arr) => {
                const next = (arr || []).map((a) => ({
                    name: a.name || '',
                    signed: !!a.signed,
                    signatureUrl: a.signatureUrl || '',
                    isLeader: !!a.isLeader
                }));
                if (!next.length) {
                    return [{ name: user.username || '', signed: false, signatureUrl: '', isLeader: true }];
                }
                next[0].isLeader = true;
                for (let i = 1; i < next.length; i++) next[i].isLeader = false;
                return next;
            };

            const handleLoadPrevious = async () => {
                try {
                    setLoading(true);
                    const q = query(
                        collection(db, "global_tbm_data"),
                        where("department", "==", user.department)
                    );
                    const snap = await getDocs(q);
                    const prev = snap.docs
                        .map(d => ({ id: d.id, ...d.data() }))
                        .sort((a, b) => String(b.date || '').localeCompare(String(a.date || '')))
                        .find(d => !initialData || d.id !== initialData.id);

                    if (!prev) {
                        showToast("ë³µì‚¬í•  ì´ì „ TBM ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.", "info");
                        return;
                    }

                    const legacyActionMap = {};
                    (prev.safetyActionChecks || []).forEach((a) => {
                        if (!a?.risk) return;
                        legacyActionMap[a.risk] = { result: a.result || 'yes', action: a.action || '' };
                    });
                    const copiedRisks = (prev.risks || [{ factor: '', measure: '' }]).map((r, i) => {
                        const legacy = legacyActionMap[r.factor] || {};
                        return {
                            id: Date.now() + i,
                            factor: r.factor || '',
                            measure: r.measure || '',
                            result: r.result || legacy.result || 'yes',
                            action: r.action || legacy.action || ''
                        };
                    });

                    setForm((cur) => ({
                        ...cur,
                        ...(copyOptions.overview ? {
                            workName: prev.workName || '',
                            workDesc: prev.workDesc || '',
                            location: prev.location || ''
                        } : {}),
                        ...(copyOptions.risks ? {
                            riskAssessmentDone: !!prev.riskAssessmentDone,
                            risks: copiedRisks,
                            keyRiskId: ''
                        } : {}),
                        ...(copyOptions.checks ? {
                            preChecks: prev.preChecks || { check1: false, check2: false, check3: false },
                            dailyCheckResult: prev.dailyCheckResult || 'íŠ¹ì´ì‚¬í•­ ì—†ìŒ'
                        } : {}),
                        ...(copyOptions.attendees ? {
                            attendees: normalizeAttendees(prev.attendees)
                        } : {
                            attendees: normalizeAttendees(cur.attendees)
                        })
                    }));
                    showToast("ì „ì£¼ ì£¼ìš” ë‚´ìš©ì„ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤. ë‚ ì§œ/ì‹œê°„ë§Œ í™•ì¸ í›„ ì €ì¥í•˜ì„¸ìš”.", "success");
                } catch (err) {
                    console.error("ì „ì£¼ ë‚´ìš© ë³µì‚¬ ì‹¤íŒ¨:", err);
                    showToast("ì´ì „ ë°ì´í„° ë³µì‚¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "error");
                } finally {
                    setLoading(false);
                }
            };

            // Photo Upload
            const handlePhotoUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        setForm(prev => ({...prev, photoUrl: reader.result}));
                    };
                    reader.readAsDataURL(file);
                }
            };

            const handleSubmit = async () => {
                if (submitting) return;
                const missing = [];
                if(!form.workName?.trim()) missing.push("ì‘ì—…ëª…");
                if(!form.location?.trim()) missing.push("ì¥ì†Œ");
                if (missing.length) return showToast(`ì €ì¥í•˜ë ¤ë©´ ${missing.join(", ")}ë§Œ ì…ë ¥í•´ ì£¼ì„¸ìš”.`, "info");
                const leader = (form.attendees || []).find(att => att.isLeader);
                if (!leader || !leader.name?.trim()) return showToast("ë¦¬ë”(ëŒ€í‘œ ì°¸ì„ì) ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.", "info");
                if (!leader.signatureUrl) return showToast("ë¦¬ë”(ëŒ€í‘œ ì°¸ì„ì) ì„œëª…ì„ ì™„ë£Œí•´ ì£¼ì„¸ìš”.", "info");
                setSubmitting(true);
                setLoading(true);
                try {
                    const selectedRisk = form.risks.find(r => r.id == form.keyRiskId);
                    const normalizedRisks = (form.risks || []).map((r) => ({
                        ...r,
                        result: r.result || 'yes',
                        action: (r.result || 'yes') === 'no' ? (r.action || '') : ''
                    }));
                    const docData = {
                        ...form,
                        risks: normalizedRisks,
                        safetyActionChecks: buildSafetyActionChecksFromRisks(normalizedRisks),
                        department: user.department,
                        keyRiskFactor: selectedRisk ? selectedRisk.factor : 'N/A',
                        keyRiskMeasure: selectedRisk ? selectedRisk.measure : 'N/A',
                        updatedAt: new Date().toISOString()
                    };
                    if (!initialData) {
                        docData.createdBy = user.username;
                        docData.createdAt = new Date().toISOString();
                        await addDoc(collection(db, "global_tbm_data"), docData);
                        showToast("ë“±ë¡ ì™„ë£Œ", "success");
                    } else {
                        await updateDoc(doc(db, "global_tbm_data", initialData.id), docData);
                        showToast("ìˆ˜ì • ì™„ë£Œ", "success");
                    }
                    if (!initialData) localStorage.removeItem(draftKey);
                    setView('list');
                } catch (err) { showToast("ì˜¤ë¥˜ ë°œìƒ", "error"); }
                setLoading(false);
                setSubmitting(false);
            };

            return (
                <div className="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden max-w-4xl mx-auto animate-fade-in-up">
                    <div className="bg-gray-800 text-white p-4 flex justify-between items-center">
                        <h2 className="text-xl font-bold"><i className="fas fa-edit mr-2"></i>{initialData ? "TBM ìˆ˜ì •" : "TBM ë“±ë¡"}</h2>
                        <span className="text-sm bg-gray-700 px-3 py-1 rounded">{user.department}</span>
                    </div>
                    <div className="p-8 space-y-8">
                        <div className="bg-indigo-50 border border-indigo-200 rounded-lg p-3 flex flex-col sm:flex-row sm:items-center justify-between gap-2 relative">
                            <div className="text-xs text-indigo-900 whitespace-nowrap">
                                í•„ìˆ˜ ì…ë ¥: <span className="font-bold">ì‘ì—…ëª…Â·ì¥ì†ŒÂ·ë¦¬ë”ì„œëª…</span>ë§Œ ì™„ë£Œ í›„ ì €ì¥ ê°€ëŠ¥ (ë‚˜ë¨¸ì§€ëŠ” í•„ìš” ì‹œ ì„ íƒ ì…ë ¥)
                            </div>
                            <div className="flex gap-1 whitespace-nowrap">
                                <button onClick={handleLoadPrevious} className="shrink-0 px-2.5 py-1.5 bg-white border border-blue-300 text-blue-700 rounded-lg text-xs font-bold hover:bg-blue-50">
                                    <i className="fas fa-copy mr-1"></i>ì „ì£¼ë³µì‚¬
                                </button>
                                <div className="relative">
                                    <button onClick={()=>setShowCopyOptions(v=>!v)} className="shrink-0 px-2.5 py-1.5 bg-white border border-blue-300 text-blue-700 rounded-lg text-xs font-bold hover:bg-blue-50">
                                        <i className="fas fa-sliders mr-1"></i>ë³µì‚¬ë²”ìœ„
                                    </button>
                                    {showCopyOptions && (
                                        <div className="absolute left-0 top-full mt-2 z-30 w-64 bg-white border border-indigo-200 rounded-lg p-3 text-sm text-gray-700 shadow-lg">
                                            <div className="font-bold mb-2 text-indigo-700">ì „ì£¼ ë‚´ìš© ë³µì‚¬ ë²”ìœ„</div>
                                            <div className="grid grid-cols-2 gap-2">
                                                <label className="flex items-center gap-2"><input type="checkbox" checked={copyOptions.overview} onChange={()=>toggleCopyOption('overview')} />ì‘ì—…ê°œìš”</label>
                                                <label className="flex items-center gap-2"><input type="checkbox" checked={copyOptions.risks} onChange={()=>toggleCopyOption('risks')} />ìœ„í—˜ì„±í‰ê°€</label>
                                                <label className="flex items-center gap-2"><input type="checkbox" checked={copyOptions.checks} onChange={()=>toggleCopyOption('checks')} />ì ê²€ê²°ê³¼</label>
                                                <label className="flex items-center gap-2"><input type="checkbox" checked={copyOptions.attendees} onChange={()=>toggleCopyOption('attendees')} />ì°¸ì„ì</label>
                                            </div>
                                        </div>
                                    )}
                                </div>
                                <button onClick={applyQuickDefaults} className="shrink-0 px-2.5 py-1.5 bg-white border border-blue-300 text-blue-700 rounded-lg text-xs font-bold hover:bg-blue-50">
                                    <i className="fas fa-wand-magic-sparkles mr-1"></i>ê¸°ë³¸ê°’
                                </button>
                                <button onClick={fillNoIssueTemplate} className="shrink-0 px-2.5 py-1.5 bg-white border border-blue-300 text-blue-700 rounded-lg text-xs font-bold hover:bg-blue-50">
                                    <i className="fas fa-file-lines mr-1"></i>ë¬´íŠ¹ì´
                                </button>
                            </div>
                        </div>

                        <section>
                            <h3 className="text-lg font-bold text-gray-700 mb-4 border-b pb-2">1. ì‘ì—… ê°œìš”</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label className="label-text">ì¼ì‹œ</label>
                                    <div className="flex gap-2 items-center flex-wrap">
                                        <input type="date" className="input-field flex-grow" value={form.date} onChange={e=>setForm({...form, date:e.target.value})} />
                                        <div className="flex items-center gap-1">
                                            <input type="time" className="input-field w-24" value={form.startTime} onChange={e=>setForm({...form, startTime:e.target.value})} />
                                            <span>~</span>
                                            <input type="time" className="input-field w-24" value={form.endTime} onChange={e=>setForm({...form, endTime:e.target.value})} />
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <label className="label-text">ì¥ì†Œ</label>
                                    <input type="text" className="input-field" value={form.location} onChange={e=>setForm({...form, location:e.target.value})} />
                                </div>
                                <div className="flex gap-4 md:col-span-2">
                                    <div className="flex-1">
                                        <label className="label-text">ì˜¨ë„ (â„ƒ)</label>
                                        <input type="number" className="input-field" placeholder="ì˜ˆ: 25" value={form.temperature} onChange={e=>setForm({...form, temperature:e.target.value})} />
                                    </div>
                                    <div className="flex-1">
                                        <label className="label-text">ìŠµë„ (%)</label>
                                        <input type="number" className="input-field" placeholder="ì˜ˆ: 50" value={form.humidity} onChange={e=>setForm({...form, humidity:e.target.value})} />
                                    </div>
                                </div>
                                <div className="md:col-span-2"><label className="label-text">ì‘ì—…ëª…</label><input type="text" className="input-field" value={form.workName} onChange={e=>setForm({...form, workName:e.target.value})} /></div>
                                <div className="md:col-span-2">
                                    <label className="label-text flex items-center justify-between">ë‚´ìš© <i className="fas fa-microphone text-gray-400 hover:text-indigo-500 cursor-pointer" title="ìŒì„± ì…ë ¥ (ì§€ì› ì˜ˆì •)"></i></label>
                                    <textarea className="input-field h-20" value={form.workDesc} onChange={e=>setForm({...form, workDesc:e.target.value})}></textarea>
                                </div>
                            </div>
                        </section>

                        <section className="bg-yellow-50 p-6 rounded-lg border border-yellow-200">
                             <div className="flex justify-between items-center mb-4">
                                <h3 className="text-lg font-bold text-yellow-800">2. ìœ„í—˜ì„± í‰ê°€</h3>
                                <div className="flex items-center gap-2"><span className="text-sm font-bold">ì‹¤ì‹œì—¬ë¶€</span><input type="checkbox" className="w-5 h-5" checked={form.riskAssessmentDone} onChange={e=>setForm({...form, riskAssessmentDone: e.target.checked})} /></div>
                            </div>
                            <div className="space-y-2">
                                <div className="grid grid-cols-12 gap-2 text-xs font-bold text-gray-500 text-center mb-1">
                                    <div className="col-span-1">No</div>
                                    <div className="col-span-3">ì ì¬ìœ„í—˜ìš”ì¸</div>
                                    <div className="col-span-3">ì•ˆì „ëŒ€ì±…</div>
                                    <div className="col-span-2">ì¡°ì¹˜ì—¬ë¶€</div>
                                    <div className="col-span-2">'ì•„ë‹ˆì˜¤' ì‚¬ìœ </div>
                                    <div className="col-span-1">ì‚­ì œ</div>
                                </div>
                                {form.risks.map((risk, idx) => (
                                    <div key={risk.id} className="grid grid-cols-12 gap-2 items-center bg-white p-2 rounded border border-yellow-100">
                                        <div className="col-span-1 text-center font-bold bg-white rounded-full w-6 h-6">{idx+1}</div>
                                        <div className="col-span-3"><input type="text" className="input-field py-1 text-sm" placeholder="ìœ„í—˜ìš”ì¸" value={risk.factor} onChange={e=>updateRisk(risk.id, 'factor', e.target.value)} /></div>
                                        <div className="col-span-3"><input type="text" className="input-field py-1 text-sm" placeholder="ëŒ€ì±…" value={risk.measure} onChange={e=>updateRisk(risk.id, 'measure', e.target.value)} /></div>
                                        <div className="col-span-2 text-center">
                                            <select className="input-field py-1 text-xs" value={risk.result || 'yes'} onChange={e=>updateRisk(risk.id, 'result', e.target.value)}>
                                                <option value="yes">ì˜ˆ</option>
                                                <option value="no">ì•„ë‹ˆì˜¤</option>
                                            </select>
                                        </div>
                                        <div className="col-span-2">
                                            <input type="text" className="input-field py-1 text-xs" placeholder="ë¯¸ì¡°ì¹˜ ì‚¬ìœ " value={risk.action || ''} onChange={e=>updateRisk(risk.id, 'action', e.target.value)} disabled={(risk.result || 'yes') === 'yes'} />
                                        </div>
                                        <div className="col-span-1 text-center"><button onClick={()=>removeRisk(risk.id)} className="text-red-400"><i className="fas fa-times"></i></button></div>
                                    </div>
                                ))}
                                <button onClick={addRiskRow} className="w-full py-2 border-2 border-dashed border-gray-300 text-gray-500 rounded text-sm hover:bg-white">+ ìœ„í—˜ìš”ì¸ ì¶”ê°€</button>
                            </div>
                            <div className="mt-4"><label className="label-text text-red-600 font-bold">ì¤‘ì  ìœ„í—˜ìš”ì¸ ì„ íƒ</label><select className="input-field" value={form.keyRiskId} onChange={e=>setForm({...form, keyRiskId: e.target.value})}><option value="">ì„ íƒí•˜ì„¸ìš”</option>{form.risks.map((r,i)=>(<option key={r.id} value={r.id}>{i+1}. {r.factor}</option>))}</select></div>
                        </section>

                        <section className="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div>
                                <h3 className="text-lg font-bold text-gray-700 mb-4 border-b pb-2">4. ì‘ì—… ì „ ì•ˆì „ ì ê²€ (Checklist)</h3>
                                <div className="space-y-2 mb-6">
                                    <label className="flex items-center p-2 border rounded bg-white"><input type="checkbox" className="mr-2" checked={form.preChecks.check1} onChange={e=>setForm({...form, preChecks:{...form.preChecks, check1:e.target.checked}})} />ë³´í˜¸êµ¬ ì°©ìš©</label>
                                    <label className="flex items-center p-2 border rounded bg-white"><input type="checkbox" className="mr-2" checked={form.preChecks.check2} onChange={e=>setForm({...form, preChecks:{...form.preChecks, check2:e.target.checked}})} />ì¥ë¹„ ì ê²€</label>
                                    <label className="flex items-center p-2 border rounded bg-white"><input type="checkbox" className="mr-2" checked={form.preChecks.check3} onChange={e=>setForm({...form, preChecks:{...form.preChecks, check3:e.target.checked}})} />ê±´ê°• ìƒíƒœ</label>
                                </div>
                                <h3 className="text-lg font-bold text-gray-700 mb-4 border-b pb-2">ì‘ì—… ì „ ì¼ì¼ ì•ˆì „ì ê²€ ì‹œí–‰ ê²°ê³¼</h3>
                                <textarea className="input-field h-[184px]" placeholder="íŠ¹ì´ì‚¬í•­ ì—†ìŒ" value={form.dailyCheckResult} onChange={e=>setForm({...form, dailyCheckResult:e.target.value})}></textarea>
                            </div>
                            <div>
                                <h3 className="text-lg font-bold text-gray-700 mb-3 border-b pb-2">5. ì°¸ì„ì ({form.attendees.length}ëª…)</h3>
                                <div className="text-xs text-indigo-700 bg-indigo-50 border border-indigo-200 rounded p-2 mb-3">
                                    ì°¸ì„ì ì´ë¦„ì€ ëª¨ë‘ ê¸°ë¡í•˜ê³ , ì„œëª…ì€ ë¦¬ë” 1ëª…ë§Œ í•„ìˆ˜ì…ë‹ˆë‹¤. ì¶”ê°€ ì°¸ì„ì ì„œëª…ì€ ì„ íƒì…ë‹ˆë‹¤.
                                </div>
                                <div className="bg-gray-50 p-4 rounded h-40 overflow-y-auto space-y-2 mb-3">
                                    {form.attendees.map((att, idx) => (
                                        <div key={idx} className="flex items-center gap-2 bg-white p-2 rounded border shadow-sm">
                                            <div className={`w-12 shrink-0 text-center px-1 py-1 rounded text-xs font-bold ${att.isLeader ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-700'}`}>
                                                {att.isLeader ? 'ë¦¬ë”' : 'ì°¸ì„'}
                                            </div>
                                            <input type="text" placeholder={att.isLeader ? "ë¦¬ë” ì´ë¦„" : "ì°¸ì„ì ì´ë¦„"} className="border border-gray-300 rounded px-3 py-2 text-sm w-24 md:w-32 shrink-0 text-center font-bold outline-none focus:ring-2 focus:ring-indigo-500 h-12" value={att.name} onChange={e=>updateAttendee(idx, e.target.value)} disabled={att.signed} />
                                            <div onClick={()=>!att.signed && openSignModal(idx)} className={`flex-1 min-w-0 h-12 border rounded flex items-center justify-center cursor-pointer transition ${att.signed ? 'bg-white border-indigo-500' : 'bg-gray-50 border-dashed hover:bg-indigo-50'}`}>
                                                {att.signed && att.signatureUrl ? <img src={att.signatureUrl} alt="ì„œëª…" className="h-full object-contain" /> : <span className="text-sm text-gray-400 font-bold whitespace-nowrap"><i className="fas fa-file-signature mr-1"></i>{att.isLeader ? 'ë¦¬ë” ì„œëª…(í•„ìˆ˜)' : 'ì„œëª… ìƒëµ ê°€ëŠ¥'}</span>}
                                            </div>
                                            {!att.isLeader && (
                                                <button onClick={() => removeAttendee(idx)} className="w-8 h-8 shrink-0 flex items-center justify-center text-red-400 hover:text-red-600 hover:bg-red-50 rounded-full transition" title="ì°¸ì„ì ì‚­ì œ">
                                                    <i className="fas fa-minus-circle"></i>
                                                </button>
                                            )}
                                        </div>
                                    ))}
                                    <button onClick={addAttendee} className="w-full py-2 bg-indigo-50 text-indigo-600 font-bold rounded text-sm hover:bg-indigo-100">+ ì°¸ì„ì ì¶”ê°€(ì„ íƒ)</button>
                                </div>
                                <h3 className="text-lg font-bold text-gray-700 mb-3 border-b pb-2">6. TBM í™œë™ ì‚¬ì§„ ì²¨ë¶€</h3>
                                <div className="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:bg-gray-50 transition relative">
                                    <input type="file" accept="image/*" onChange={handlePhotoUpload} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
                                    {form.photoUrl ? (
                                        <img src={form.photoUrl} alt="Preview" className="max-h-32 mx-auto rounded shadow" />
                                    ) : (
                                        <div className="text-gray-400"><i className="fas fa-camera text-3xl mb-2"></i><br/>í´ë¦­í•˜ì—¬ ì‚¬ì§„ ì´¬ì˜/ì—…ë¡œë“œ</div>
                                    )}
                                </div>
                            </div>
                        </section>
                        <div className="pt-6 border-t flex justify-end gap-4">
                            <button onClick={()=>setView('list')} className="px-6 py-3 border rounded">ì·¨ì†Œ</button>
                            <button onClick={handleSubmit} disabled={submitting} className={`px-8 py-3 text-white rounded font-bold shadow-lg ${submitting ? 'bg-indigo-400 cursor-not-allowed' : 'bg-indigo-600 hover:bg-indigo-700'}`}>
                                {submitting ? <><i className="fas fa-spinner fa-spin mr-2"></i>ì €ì¥ ì¤‘...</> : 'ì €ì¥'}
                            </button>
                        </div>
                    </div>
                    <SignatureModal isOpen={showSignModal} onClose={()=>setShowSignModal(false)} onSave={handleSaveSignature} signerName={currentSignerIndex!==null?form.attendees[currentSignerIndex].name:''} />
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null); 
            const [view, setView] = useState('login'); 
            const [loading, setLoading] = useState(true);
            const [toast, setToast] = useState(null);
            const [tbms, setTbms] = useState([]);
            const [accounts, setAccounts] = useState([]);
            const [currentYear, setCurrentYear] = useState('2026'); // Default 2026
            const [availableYears, setAvailableYears] = useState(['2026']); // Default Only 2026
            const [loginId, setLoginId] = useState('');
            const [loginPw, setLoginPw] = useState('');
            const [saveId, setSaveId] = useState(false);
            const [editTbmData, setEditTbmData] = useState(null);
            
            // PDF Generation State
            const [downloadingPdf, setDownloadingPdf] = useState(false);
            const [targetPdfTbm, setTargetPdfTbm] = useState(null);

            useEffect(() => {
                const saved = localStorage.getItem('savedId');
                if (saved) { setLoginId(saved); setSaveId(true); }

                let unsubUsers = null;
                let unsubTbms = null;
                let mounted = true;

                const init = async () => {
                    try {
                        await signInAnonymously(auth);

                        // Fetch System Config
                        const configDoc = await getDoc(doc(db, "system_settings", "config"));
                        if (mounted && configDoc.exists()) {
                            setAvailableYears(configDoc.data().years || ['2026']);
                        }

                        // --- Sort Logic Applied Here (Global) ---
                        unsubUsers = onSnapshot(
                            query(collection(db, "app_users")),
                            (s) => {
                                if (!mounted) return;
                                const fetchedAccounts = s.docs.map(d => ({id:d.id, ...d.data()}));
                                fetchedAccounts.sort((a, b) => {
                                    const deptA = a.department || '';
                                    const deptB = b.department || '';
                                    return deptA.localeCompare(deptB, 'ko');
                                });
                                setAccounts(fetchedAccounts);
                            },
                            (err) => {
                                console.error("app_users êµ¬ë… ì‹¤íŒ¨:", err);
                                if (mounted) setToast({ message: "ê³„ì • ë°ì´í„° êµ¬ë… ì‹¤íŒ¨", type: "error" });
                            }
                        );

                        unsubTbms = onSnapshot(
                            query(collection(db, "global_tbm_data"), orderBy("createdAt", "desc")),
                            (s) => {
                                if (!mounted) return;
                                setTbms(s.docs.map(d => ({id:d.id, ...d.data()})));
                                setLoading(false);
                            },
                            (err) => {
                                console.error("global_tbm_data êµ¬ë… ì‹¤íŒ¨:", err);
                                if (mounted) {
                                    setToast({ message: "TBM ë°ì´í„° êµ¬ë… ì‹¤íŒ¨", type: "error" });
                                    setLoading(false);
                                }
                            }
                        );
                    } catch (err) {
                        console.error("ì´ˆê¸°í™” ì‹¤íŒ¨:", err);
                        if (mounted) {
                            setToast({ message: "ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", type: "error" });
                            setLoading(false);
                        }
                    }
                };
                init();

                return () => {
                    mounted = false;
                    if (typeof unsubUsers === 'function') unsubUsers();
                    if (typeof unsubTbms === 'function') unsubTbms();
                };
            }, []);

            const showToast = (msg, type = 'info') => setToast({ message: msg, type });

            const handleLogin = async (e) => {
                e.preventDefault();
                setLoading(true);
                if (saveId) localStorage.setItem('savedId', loginId);
                else localStorage.removeItem('savedId');

                try {
                    // ìš´ì˜ ì—°ì†ì„±: master ê³„ì •ì´ ì•„ì§ ì—†ì„ ë•Œë§Œ ì„ì‹œ ê´€ë¦¬ì ë¡œê·¸ì¸ í—ˆìš©
                    if (loginId === 'admin' && loginPw === '0908') {
                        const realMaster = accounts.find(a => a.role === 'master');
                        if (!realMaster || accounts.length === 0) {
                            setUser({ id: 'temp_master', username: 'Master Admin', role: 'master', department: 'ê²½ì˜ê¸°íšíŒ€' });
                            setView('dashboard');
                            showToast('ê´€ë¦¬ìë¡œ ë¡œê·¸ì¸í–ˆìŠµë‹ˆë‹¤.', 'success');
                            return;
                        }
                    }

                    const normalizedLoginId = String(loginId || '').trim();
                    const foundUser = accounts.find(a => String(a.username || '').trim() === normalizedLoginId);
                    if (!foundUser) {
                        showToast('ì •ë³´ ë¶ˆì¼ì¹˜', 'error');
                        return;
                    }

                    const ok = await verifyPassword(loginPw, foundUser);
                    if (!ok) {
                        showToast('ì •ë³´ ë¶ˆì¼ì¹˜', 'error');
                        return;
                    }

                    // Legacy plain-password account is upgraded to hash after successful login.
                    if (!foundUser.passwordHash && typeof foundUser.password === 'string') {
                        const passwordHash = await hashPassword(loginPw);
                        await updateDoc(doc(db, "app_users", foundUser.id), {
                            passwordHash,
                            updatedAt: new Date().toISOString()
                        });
                    }

                    setUser(foundUser);
                    setView('dashboard');
                    showToast('ë¡œê·¸ì¸ ì„±ê³µ', 'success');
                } catch (err) {
                    console.error("ë¡œê·¸ì¸ ì²˜ë¦¬ ì‹¤íŒ¨:", err);
                    showToast('ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜', 'error');
                } finally {
                    setLoading(false);
                }
            };

            const handleEditTbm = (tbm) => {
                setEditTbmData(tbm);
                setView('write');
            };

            const handleDeleteTbm = async (id) => {
                if(confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    await deleteDoc(doc(db, "global_tbm_data", id));
                    showToast("ì‚­ì œ ì™„ë£Œ", "success");
                }
            };
            
            const handlePdfDownload = (tbm) => {
                showToast("PDF ìƒì„±ì„ ì‹œì‘í•©ë‹ˆë‹¤...", "info");
                setTargetPdfTbm(tbm);
                setDownloadingPdf(true);
            };

            const handlePdfComplete = () => {
                setDownloadingPdf(false);
                setTargetPdfTbm(null);
                showToast("PDF ë‹¤ìš´ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
            };

            const handleLogout = () => { setUser(null); setView('login'); setLoginId(''); setLoginPw(''); };

            const myTbms = useMemo(() => {
                if (!user) return [];
                const filtered = tbms.filter(t => t.date.startsWith(currentYear));
                if (user.role === 'master') return filtered;
                return filtered.filter(t => t.department === user.department);
            }, [tbms, user, currentYear]);

            const stats = useMemo(() => {
                const yearTbms = tbms.filter(t => t.date.startsWith(currentYear));
                const total = yearTbms.length;
                const safeCount = yearTbms.filter(t => t.riskAssessmentDone).length;
                const monthlyData = Array.from({length: 12}, (_, i) => ({ label: `${i+1}ì›”`, value: 0 }));
                yearTbms.forEach(t => {
                    if(t.date) monthlyData[new Date(t.date).getMonth()].value++;
                });
                return { total, safeCount, monthlyData: monthlyData }; // REMOVED SLICE
            }, [tbms, currentYear]);

            if (loading && !user && view !== 'login') return <div className="h-screen flex items-center justify-center flex-col"><i className="fas fa-circle-notch fa-spin text-4xl text-indigo-600 mb-4"></i><p>Loading...</p></div>;

            return (
                <div className="flex h-screen overflow-hidden">
                    {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
                    
                    {/* Hidden PDF Generator */}
                    {downloadingPdf && targetPdfTbm && (
                        <PdfHiddenGenerator tbm={targetPdfTbm} onComplete={handlePdfComplete} />
                    )}

                    {view === 'login' ? (
                        <div className="w-full"><LoginView loginId={loginId} setLoginId={setLoginId} loginPw={loginPw} setLoginPw={setLoginPw} handleLogin={handleLogin} saveId={saveId} setSaveId={setSaveId} loading={loading} /></div>
                    ) : (
                        <>
                            <Sidebar user={user} view={view} setView={(v) => { if(v==='write') setEditTbmData(null); setView(v); }} handleLogout={handleLogout} />
                            <main className="flex-1 ml-64 p-8 overflow-y-auto h-screen app-main">
                                {view === 'dashboard' && <DashboardView stats={stats} tbms={tbms} currentYear={currentYear} setCurrentYear={setCurrentYear} allTbms={tbms} availableYears={availableYears} />}
                                {view === 'list' && (
                                    <ListView 
                                        user={user} 
                                        myTbms={myTbms} 
                                        setView={(v) => { if(v==='write') setEditTbmData(null); setView(v); }} 
                                        accounts={accounts} 
                                        allTbms={tbms} 
                                        currentYear={currentYear} 
                                        setCurrentYear={setCurrentYear} 
                                        onEdit={handleEditTbm} 
                                        onDelete={handleDeleteTbm} 
                                        onPdfDownload={handlePdfDownload}
                                        availableYears={availableYears}
                                    />
                                )}
                                {view === 'write' && <TBMFormView user={user} setView={setView} showToast={showToast} setLoading={setLoading} initialData={editTbmData} />}
                                {view === 'admin' && <AdminView accounts={accounts} showToast={showToast} />}
                                {view === 'settings' && <SettingsView availableYears={availableYears} setAvailableYears={setAvailableYears} />}
                            </main>
                        </>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ErrorBoundary><App /></ErrorBoundary>);
        
        // Dynamic Style for animation
        const styleSheet = document.createElement("style");
        styleSheet.innerText = `
            .app-main {
                background:
                    radial-gradient(700px 300px at 0% 0%, rgba(59,130,246,0.12), transparent 60%),
                    radial-gradient(700px 300px at 100% 0%, rgba(14,165,233,0.1), transparent 60%),
                    #f7faff;
            }
            .input-field {
                width: 100%;
                border: 1px solid #d2deee;
                border-radius: 0.75rem;
                padding: 0.62rem 0.82rem;
                background: #ffffff;
                outline: none;
                transition: border-color 0.2s, box-shadow 0.2s, background 0.2s;
            }
            .input-field:focus {
                border-color: #1a73e8;
                box-shadow: 0 0 0 3px rgba(26,115,232,0.15);
                background: #fbfdff;
            }
            .label-text {
                display: block;
                font-size: 0.84rem;
                font-weight: 700;
                color: #42526a;
                margin-bottom: 0.35rem;
                letter-spacing: -0.01em;
            }
            .bg-white, .bg-white\\/95 {
                box-shadow: 0 10px 28px rgba(15, 23, 42, 0.06);
            }
            @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
            .animate-fade-in-up { animation: fadeInUp 0.5s ease-out forwards; }
            @keyframes bounceIn { 0% { transform: scale(0.9); opacity: 0; } 70% { transform: scale(1.05); } 100% { transform: scale(1); opacity: 1; } }
            .animate-bounce-in { animation: bounceIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        `;
        document.head.appendChild(styleSheet);
    </script>
</body>
</html>
